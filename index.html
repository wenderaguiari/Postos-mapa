<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Postos - Alloha Fibra</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      background: #f3f6fb;
      color: #001059;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: #001059;
      color: #f9fafb;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 4px 0 10px rgba(0,0,0,0.25);
    }

    .sidebar-logo img {
      max-width: 140px;
      display: block;
      margin: 0 auto 6px;
    }

    .sidebar-title-main {
      font-size: 16px;
      font-weight: 600;
    }

    .sidebar-title-sub {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #48ef6c;
      color: #48ef6c;
      background: rgba(72,239,108,0.15);
    }

    #statsBox {
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.4;
    }
    #statsBox span {
      font-weight: 600;
    }

    /* PAINEL CENTRAL */
    .main-panel {
      width: 420px;
      background: #ffffff;
      padding: 10px 14px;
      border-right: 2px solid #001059;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
    }

    h2 {
      margin: 0 0 4px;
      font-size: 16px;
    }

    small {
      font-size: 12px;
      color: #6b7280;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin: 6px 0 2px;
      display: block;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 6px 9px;
      border-radius: 999px;
      border: 2px solid #001059;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: #48ef6c;
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(72,239,108,0.25);
    }

    .section-card {
      margin-top: 8px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 8px;
      font-size: 13px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 600;
    }

    .section-count {
      font-size: 12px;
      color: #6b7280;
      margin-left: 4px;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
    }

    .badge-abaixo { background:#dcfce7; color:#166534; }
    .badge-media  { background:#dbeafe; color:#1d4ed8; }
    .badge-acima  { background:#fef9c3; color:#854d0e; }
    .badge-muito  { background:#fee2e2; color:#b91c1c; }

    .posto-item {
      padding: 5px 2px;
      border-bottom: 1px dashed #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }
    .posto-item:last-child { border-bottom:none; }
    .posto-item:hover { background:#e5ebff; }

    .posto-nome {
      font-weight: 600;
      color: #111827;
    }

    .posto-det {
      font-size: 12px;
      color: #6b7280;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }

    th {
      background:#001059;
      color:#f9fafb;
      padding:5px;
      font-weight:600;
      text-align: left;
    }
    td {
      padding:5px 4px;
      border:1px solid #e5e7eb;
    }
    tbody tr:hover {
      background:#e5ebff;
      cursor:pointer;
    }

    /* MAPA */
    .map-panel {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-panel h3 {
      margin: 0;
      font-size: 15px;
    }
    .map-panel small {
      font-size: 11px;
    }

    #map {
      flex: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #001059;
    }

    /* LOADER */
    .loader {
      position: fixed;
      top:50%;
      left:50%;
      width:32px;
      height:32px;
      border-radius:50%;
      border:4px solid #e5e7eb;
      border-top:4px solid #48ef6c;
      transform:translate(-50%,-50%);
      animation:spin 1s linear infinite;
      display:none;
      z-index:999;
    }
    @keyframes spin {
      0% { transform:translate(-50%,-50%) rotate(0deg); }
      100%{ transform:translate(-50%,-50%) rotate(360deg); }
    }

  </style>
</head>

<body>
<div class="loader" id="loader"></div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <img src="Imagem1.png" alt="Alloha Fibra">
  </div>
  <div class="sidebar-title-main">Painel de Postos</div>
  <div class="sidebar-title-sub">Desvio de Preço & Classificação</div>
  <span class="tag">Alloha Frotas · Uso interno</span>

  <div id="statsBox">
    <div>Abaixo: <span id="statsAbaixo">0</span></div>
    <div>Média: <span id="statsMedia">0</span></div>
    <div>Acima: <span id="statsAcima">0</span></div>
    <div>Muito acima: <span id="statsMuito">0</span></div>
  </div>
</aside>

<!-- PAINEL CENTRAL -->
<main class="main-panel">

  <section>
    <h2>Filtros</h2>
    <small>Use os filtros para localizar rapidamente os postos.</small>

    <label for="filtroUF">UF</label>
    <select id="filtroUF">
      <option value="">Todas</option>
    </select>

    <label for="filtroCidade">Cidade</label>
    <select id="filtroCidade">
      <option value="">Todas</option>
    </select>

    <label for="filtroMercadoria">Mercadoria</label>
    <select id="filtroMercadoria">
      <option value="">Todas</option>
    </select>

    <label for="filtroNome">Nome do posto</label>
    <input type="text" id="filtroNome" placeholder="Digite parte do nome" />

    <label for="filtroEndereco">Endereço</label>
    <input type="text" id="filtroEndereco" placeholder="Digite parte do endereço" />
  </section>

  <!-- LISTA TOP 10 ABAIXO + MÉDIA -->
  <section class="section-card" id="cardLista">
    <div class="section-title">
      <span class="badge badge-abaixo">Abaixo</span>
      <span class="badge badge-media">Na média</span>
      Top 10 mais baratos
      <span class="section-count" id="countLista">(0)</span>
    </div>
    <div id="listaPostos"></div>
  </section>

  <!-- TABELA ACIMA + MUITO ACIMA -->
  <section class="section-card" id="cardTabela">
    <div class="section-title">
      <span class="badge badge-acima">Acima</span>
      <span class="badge badge-muito">Muito acima</span>
      Postos com desvio crítico
      <span class="section-count" id="countTabela">(0)</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Posto</th>
          <th>Cidade/UF</th>
          <th>Desvio (%)</th>
          <th>Preço (R$)</th>
          <th>Grupo</th>
        </tr>
      </thead>
      <tbody id="tabelaAcima"></tbody>
    </table>
  </section>

</main>

<!-- MAPA -->
<section class="map-panel">
  <h3>Mapa – Postos abaixo da média</h3>
  <small>Somente os postos abaixo da média/na média aparecem no mapa (TOP 10 para desempenho).</small>
  <div id="map"></div>
</section>

<script>
  const CSV_FILE = "postos-mapa.csv";

  let postos = [];
  let map, markersLayer;

  // Cache local de geocodificação
  const geocodeCache =
    JSON.parse(localStorage.getItem("geocodeCachePostos")) || {};

  function saveCache() {
    localStorage.setItem("geocodeCachePostos", JSON.stringify(geocodeCache));
  }

  function showLoader(show) {
    const loader = document.getElementById("loader");
    if (!loader) return;
    loader.style.display = show ? "block" : "none";
  }

  function getCol(row, name) {
    const key = Object.keys(row).find(k => k.trim() === name);
    return key ? row[key] : "";
  }

  function parsePreco(v) {
    if (!v) return null;
    let s = String(v).replace(/[R$\s]/g, "");
    if (s.includes(",") && !s.includes(".")) s = s.replace(",", ".");
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  }

  function parseDesvio(v) {
    if (!v) return null;
    let s = String(v).replace("%", "").trim();
    if (s.includes(",") && !s.includes(".")) s = s.replace(",", ".");
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  }

  function fmt2(n) {
    return n !== null && n !== undefined && !isNaN(n) ? n.toFixed(2) : "";
  }

  function classificarStatus(blacklist) {
    if (!blacklist) return "desconhecido";
    const s = String(blacklist);
    if (s.includes("Abaixo da média")) return "abaixo";
    if (s.includes("Dentro da média")) return "media";
    if (s.includes("Muito acima")) return "muito_acima";
    if (s.includes("Acima da média")) return "acima";
    return "desconhecido";
  }

  /* ============ CSV ============ */
  showLoader(true);

  Papa.parse(CSV_FILE, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      postos = results.data
        .map(row => {
          const nome = getCol(row, "Nome EC");
          const uf = getCol(row, "UF EC");
          const cidade = getCol(row, "Cidade EC");
          const logradouro = getCol(row, "Logradouro EC");
          const mercadoria = getCol(row, "Mercadoria");
          const precoBruto =
            getCol(row, "Preço por Litro") || getCol(row, " Preço por Litro ");
          const desvioBruto = getCol(row, "Desvio de Preço (%)");
          const blacklist = getCol(row, "Blacklist");

          if (!nome || !uf || !cidade || !logradouro) return null;

          return {
            nome: String(nome).trim(),
            uf: String(uf).trim(),
            cidade: String(cidade).trim(),
            endereco: String(logradouro).trim(),
            mercadoria: mercadoria ? String(mercadoria).trim() : "",
            precoNum: parsePreco(precoBruto),
            desvioNum: parseDesvio(desvioBruto),
            blacklist,
            status: classificarStatus(blacklist),
            _marker: null
          };
        })
        .filter(x => x !== null);

      inicializarMapa();
      inicializarFiltros();
      atualizarInterface();
      showLoader(false);
    },
    error: () => showLoader(false)
  });

  /* ============ FILTROS ============ */

  function inicializarFiltros() {
    const ufSel = document.getElementById("filtroUF");
    const cidSel = document.getElementById("filtroCidade");
    const mercSel = document.getElementById("filtroMercadoria");
    const nomeInp = document.getElementById("filtroNome");
    const endInp = document.getElementById("filtroEndereco");

    // UFs
    const ufs = [...new Set(postos.map(p => p.uf))].sort();
    ufs.forEach(uf => {
      const opt = document.createElement("option");
      opt.value = uf;
      opt.textContent = uf;
      ufSel.appendChild(opt);
    });

    // Mercadoria
    const mercadorias = [...new Set(
      postos.map(p => p.mercadoria).filter(v => v)
    )].sort();
    mercadorias.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      mercSel.appendChild(opt);
    });

    ufSel.addEventListener("change", () => {
      preencherCidades();
      aplicarFiltrosDebounced();
    });
    cidSel.addEventListener("change", aplicarFiltrosDebounced);
    mercSel.addEventListener("change", aplicarFiltrosDebounced);
    nomeInp.addEventListener("input", aplicarFiltrosDebounced);
    endInp.addEventListener("input", aplicarFiltrosDebounced);

    preencherCidades();
  }

  function preencherCidades() {
    const uf = document.getElementById("filtroUF").value;
    const cidSel = document.getElementById("filtroCidade");
    cidSel.innerHTML = '<option value="">Todas</option>';

    const cidades = [...new Set(
      postos.filter(p => !uf || p.uf === uf).map(p => p.cidade)
    )].sort();

    cidades.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      cidSel.appendChild(opt);
    });
  }

  function filtrarPostos() {
    const uf = document.getElementById("filtroUF").value;
    const cidade = document.getElementById("filtroCidade").value;
    const mercadoria = document.getElementById("filtroMercadoria").value;
    const nome = document.getElementById("filtroNome").value.toLowerCase();
    const endereco = document.getElementById("filtroEndereco").value.toLowerCase();

    return postos.filter(p =>
      (!uf || p.uf === uf) &&
      (!cidade || p.cidade === cidade) &&
      (!mercadoria || p.mercadoria === mercadoria) &&
      (!nome || p.nome.toLowerCase().includes(nome)) &&
      (!endereco || p.endereco.toLowerCase().includes(endereco))
    );
  }

  // Debounce simples para evitar filtros constantes
  let filtroTimeout = null;
  function aplicarFiltrosDebounced() {
    if (filtroTimeout) clearTimeout(filtroTimeout);
    filtroTimeout = setTimeout(() => {
      atualizarInterface();
    }, 250);
  }

  /* ============ MAPA ============ */

  function inicializarMapa() {
    map = L.map("map").setView([-14.5, -51.5], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }

  async function geocodeEndereco(posto) {
    let enderecoBusca = posto.endereco || "";
    if (!/\d/.test(enderecoBusca)) {
      enderecoBusca = enderecoBusca.split(",")[0];
    }

    const chave = `${enderecoBusca}, ${posto.cidade} - ${posto.uf}`;
    if (geocodeCache[chave]) return geocodeCache[chave];

    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(chave)}`;
    try {
      const resp = await fetch(url, { headers: { "Accept-Language": "pt-BR" } });
      const data = await resp.json();
      if (data && data.length > 0) {
        const coord = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
        geocodeCache[chave] = coord;
        saveCache();
        return coord;
      }
    } catch (e) {
      console.error("Erro geocode:", e);
    }
    return null;
  }

  async function atualizarMapa(lista) {
    if (!map || !markersLayer) return;

    markersLayer.clearLayers();

    // Apenas abaixo/na média
    const abaixoMedia = lista.filter(
      p => p.status === "abaixo" || p.status === "media"
    );

    if (abaixoMedia.length === 0) return;

    // TOP 10 mais baratos
    const limitados = abaixoMedia
      .slice() // cópia
      .sort((a, b) => (a.precoNum ?? 999999) - (b.precoNum ?? 999999))
      .slice(0, 10);

    const results = await Promise.all(
      limitados.map(async posto => {
        const coord = await geocodeEndereco(posto);
        return { posto, coord };
      })
    );

    const bounds = [];

    results.forEach(({ posto, coord }) => {
      if (!coord) return;

      const marker = L.circleMarker([coord.lat, coord.lon], {
        radius: 6,
        fillColor: "#22c55e",
        color: "#14532d",
        weight: 2,
        fillOpacity: 0.9
      }).addTo(markersLayer);

      marker.bindPopup(`
        <strong>${posto.nome}</strong><br>
        ${posto.endereco}<br>
        ${posto.cidade} - ${posto.uf}<br>
        Desvio: ${fmt2(posto.desvioNum)}%<br>
        Preço: R$ ${fmt2(posto.precoNum)}
      `);

      posto._marker = marker;
      bounds.push([coord.lat, coord.lon]);
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [30, 30] });
    }
  }

  /* ============ LISTA E TABELA ============ */

  function atualizarLista(lista) {
    const listaDiv = document.getElementById("listaPostos");
    const countEl = document.getElementById("countLista");
    listaDiv.innerHTML = "";

    // Abaixo + média, ordenado por preço, TOP 10
    const top = lista
      .filter(p => p.status === "abaixo" || p.status === "media")
      .sort((a, b) => (a.precoNum ?? 999999) - (b.precoNum ?? 999999))
      .slice(0, 10);

    countEl.textContent = `(${top.length})`;

    top.forEach(p => {
      const div = document.createElement("div");
      div.className = "posto-item";
      div.innerHTML = `
        <div class="posto-nome">${p.nome}</div>
        <div class="posto-det">${p.cidade} - ${p.uf}</div>
        <div class="posto-det">R$ ${fmt2(p.precoNum)} • ${fmt2(p.desvioNum)}%</div>
      `;
      div.addEventListener("click", () => focarNoMapa(p));
      listaDiv.appendChild(div);
    });
  }

  function atualizarTabela(lista) {
    const tbody = document.getElementById("tabelaAcima");
    const countEl = document.getElementById("countTabela");
    tbody.innerHTML = "";

    const criticos = lista.filter(
      p => p.status === "acima" || p.status === "muito_acima"
    );

    criticos.sort((a, b) => (b.desvioNum ?? 0) - (a.desvioNum ?? 0));
    countEl.textContent = `(${criticos.length})`;

    criticos.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.cidade} / ${p.uf}</td>
        <td>${fmt2(p.desvioNum)}%</td>
        <td>R$ ${fmt2(p.precoNum)}</td>
        <td>${p.status}</td>
      `;
      tr.addEventListener("click", () => focarNoMapa(p));
      tbody.appendChild(tr);
    });
  }

  /* ============ STATS (FILTRADOS) ============ */

  function atualizarStats(lista) {
    const abaixo = lista.filter(p => p.status === "abaixo").length;
    const media = lista.filter(p => p.status === "media").length;
    const acima = lista.filter(p => p.status === "acima").length;
    const muito = lista.filter(p => p.status === "muito_acima").length;

    document.getElementById("statsAbaixo").textContent = abaixo;
    document.getElementById("statsMedia").textContent = media;
    document.getElementById("statsAcima").textContent = acima;
    document.getElementById("statsMuito").textContent = muito;
  }

  /* ============ FOCAR NO MAPA ============ */

  async function focarNoMapa(posto) {
    // Se já tiver marker (por estar no TOP 10 do mapa)
    if (posto._marker) {
      map.setView(posto._marker.getLatLng(), 16, { animate: true });
      posto._marker.openPopup();
      return;
    }

    // Se não está no mapa, cria marcador temporário
    const coord = await geocodeEndereco(posto);
    if (!coord) return;

    const temp = L.marker([coord.lat, coord.lon]).addTo(map);
    temp.bindPopup(posto.nome).openPopup();
    map.setView([coord.lat, coord.lon], 16, { animate: true });
    setTimeout(() => map.removeLayer(temp), 3000);
  }

  /* ============ ATUALIZAÇÃO GERAL ============ */

  function atualizarInterface() {
    const filtrados = filtrarPostos();
    atualizarStats(filtrados);
    atualizarLista(filtrados);
    atualizarTabela(filtrados);
    // Atualiza mapa sem bloquear a UI
    atualizarMapa(filtrados);
  }
</script>
</body>
</html>
