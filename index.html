<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Postos - Alloha Fibra</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial;
      background: #f3f6fb;
      color: #001059;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #001059;
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 4px 0 10px rgba(0,0,0,0.25);
    }

    .sidebar img {
      max-width: 160px;
      display: block;
      margin: 0 auto;
    }

    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #48ef6c;
      color: #48ef6c;
      font-size: 11px;
    }

    /* Painel central */
    .main-panel {
      width: 420px;
      background: white;
      padding: 16px;
      overflow-y: auto;
      border-right: 3px solid #001059;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 2px solid #001059;
      background: #f9fafb;
      font-size: 13px;
      outline: none;
      transition: 0.2s;
    }
    select:focus, input:focus {
      border-color: #48ef6c;
      box-shadow: 0 0 4px rgba(72,239,108,0.4);
      background: white;
    }

    /* Cards */
    .section-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(15,23,42,0.08);
    }

    .highlight {
      animation: blink 0.5s ease-in-out;
    }
    @keyframes blink {
      0% { background: #d9ffe0; }
      100% { background: transparent; }
    }

    .badge {
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: bold;
    }
    .badge-abaixo { background:#dcfce7; color:#166534; }
    .badge-media { background:#dbeafe; color:#1d4ed8; }
    .badge-acima { background:#fef9c3; color:#854d0e; }
    .badge-muito { background:#fee2e2; color:#b91c1c; }

    .posto-item {
      padding: 6px;
      border-bottom: 1px dashed #ccc;
      font-size: 12px;
    }

    /* Tabela minimalista */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 11px;
    }

    table thead {
      background: #001059;
      color: white;
    }

    table th, table td {
      padding: 6px;
      border: 1px solid #ddd;
    }

    /* Mapa */
    .map-panel {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #map {
      flex: 1;
      border-radius: 12px;
      overflow: hidden;
    }

    /* Loader */
    .loader {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 5px solid #e5e7eb;
      border-top: 5px solid #48ef6c;
      transform: translate(-50%, -50%);
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body>

<div class="loader" id="loader"></div>

<!-- Sidebar -->
<aside class="sidebar">
  <img src="Imagem1.png">
  <div>
    <h3>Painel de Postos</h3>
    <p>Desvio de Preço & Classificação</p>
    <span class="tag">Alloha Frotas · Uso interno</span>
  </div>

  <div id="statsBox">
    <p>Abaixo: <span id="sAbaixo">0</span></p>
    <p>Média: <span id="sMedia">0</span></p>
    <p>Acima: <span id="sAcima">0</span></p>
    <p>Muito acima: <span id="sMuit">0</span></p>
  </div>
</aside>

<!-- Painel central -->
<main class="main-panel">

  <h2>Filtros</h2>

  <label>UF</label>
  <select id="filtroUF"><option value="">Todas</option></select>

  <label>Cidade</label>
  <select id="filtroCidade"><option value="">Todas</option></select>

  <label>Mercadoria</label>
  <select id="filtroMerc"><option value="">Todas</option></select>

  <label>Nome do posto</label>
  <input type="text" id="filtroNome" placeholder="Digite parte do nome">

  <label>Endereço</label>
  <input type="text" id="filtroEndereco" placeholder="Digite parte do endereço">

  <!-- Lista abaixo + média -->
  <div class="section-card" id="cardLista">
    <h4>
      <span class="badge badge-abaixo">Abaixo</span>
      <span class="badge badge-media">Na média</span>
      Postos aceitáveis ou melhores
      (<span id="countLista">0</span>)
    </h4>
    <div id="listaPostos"></div>
  </div>

  <!-- Tabela acima + muito acima -->
  <div class="section-card" id="cardTabela">
    <h4>
      <span class="badge badge-acima">Acima</span>
      <span class="badge badge-muito">Muito acima</span>
      Postos com desvio crítico
      (<span id="countTabela">0</span>)
    </h4>

    <table>
      <thead>
        <tr>
          <th>Posto</th>
          <th>Cidade/UF</th>
          <th>Desvio (%)</th>
          <th>Preço (R$)</th>
          <th>Grupo</th>
        </tr>
      </thead>
      <tbody id="tabelaAcima"></tbody>
    </table>
  </div>

</main>

<!-- Painel do mapa -->
<section class="map-panel">
  <h3>Mapa – Postos abaixo da média</h3>
  <small>Somente os postos abaixo da média aparecem no mapa.</small>
  <div id="map"></div>
</section>

<!-- PARTE 2 CHEGA NA PRÓXIMA MENSAGEM -->
<script>
  const CSV_FILE = "postos-mapa.csv";

  const loader = document.getElementById("loader");
  const cardLista = document.getElementById("cardLista");
  const cardTabela = document.getElementById("cardTabela");

  let postos = [];
  let map, markersLayer;
  const geocodeCache = {};

  function showLoader(show) {
    loader.style.display = show ? "block" : "none";
  }

  function highlight(el) {
    if (!el) return;
    el.classList.add("highlight");
    setTimeout(() => el.classList.remove("highlight"), 400);
  }

  function getCol(row, name) {
    const key = Object.keys(row).find(k => k.trim() === name);
    return key ? row[key] : "";
  }

  function parsePreco(v) {
    if (!v) return null;
    let s = String(v).replace(/[R$\s]/g, "");
    if (s.includes(",") && !s.includes(".")) s = s.replace(",", ".");
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  }

  function parseDesvio(v) {
    if (!v) return null;
    let s = String(v).replace("%", "");
    if (s.includes(",") && !s.includes(".")) s = s.replace(",", ".");
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  }

  function fmt2(n) {
    return n != null ? n.toFixed(2) : "";
  }

  function classificarStatus(s) {
    if (!s) return "desconhecido";
    if (s.includes("Abaixo")) return "abaixo";
    if (s.includes("Dentro") || s.includes("Média")) return "media";
    if (s.includes("Muito acima")) return "muito_acima";
    if (s.includes("Acima")) return "acima";
    return "desconhecido";
  }

  // ====================== LER CSV ======================
  showLoader(true);

  Papa.parse(CSV_FILE, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: results => {
      postos = results.data
        .map(row => {
          const nome = getCol(row, "Nome EC");
          const uf = getCol(row, "UF EC");
          const cidade = getCol(row, "Cidade EC");
          const endereco = getCol(row, "Logradouro EC");
          const mercadoria = getCol(row, "Mercadoria");
          const precoBruto = getCol(row, "Preço por Litro");
          const desvioBruto = getCol(row, "Desvio de Preço (%)");
          const blacklist = getCol(row, "Blacklist");

          if (!nome || !uf || !cidade || !endereco) return null;

          return {
            nome: nome.trim(),
            uf: uf.trim(),
            cidade: cidade.trim(),
            endereco: endereco.trim(),
            mercadoria: mercadoria ? mercadoria.trim() : "",
            precoNum: parsePreco(precoBruto),
            desvioNum: parseDesvio(desvioBruto),
            status: classificarStatus(blacklist),
            blacklist
          };
        })
        .filter(x => x);

      inicializarMapa();
      inicializarFiltros();
      atualizarContadorBlacklist();

      atualizarInterface().then(() => showLoader(false));
    },
    error: err => {
      console.error("Erro ao ler CSV:", err);
      showLoader(false);
    }
  });

  // ==================== CONTADOR BLACKLIST ====================
  function atualizarContadorBlacklist() {
    const cont = { abaixo: 0, media: 0, acima: 0, muito_acima: 0 };

    postos.forEach(p => {
      if (cont[p.status] !== undefined) cont[p.status]++;
    });

    document.getElementById("sAbaixo").textContent = cont.abaixo;
    document.getElementById("sMedia").textContent = cont.media;
    document.getElementById("sAcima").textContent = cont.acima;
    document.getElementById("sMuit").textContent = cont.muito_acima;
  }

  // ==================== FILTROS ====================

  function inicializarFiltros() {
    const ufSelect = document.getElementById("filtroUF");
    const cidadeSelect = document.getElementById("filtroCidade");
    const mercSelect = document.getElementById("filtroMerc");
    const nomeInput = document.getElementById("filtroNome");
    const endInput = document.getElementById("filtroEndereco");

    const ufs = [...new Set(postos.map(p => p.uf))].sort();
    ufs.forEach(uf => {
      const opt = document.createElement("option");
      opt.value = uf;
      opt.textContent = uf;
      ufSelect.appendChild(opt);
    });

    const mercadorias = [...new Set(
      postos.map(p => (p.mercadoria || "").trim()).filter(v => v)
    )].sort();

    mercadorias.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      mercSelect.appendChild(opt);
    });

    ufSelect.addEventListener("change", () => {
      preencherCidades();
      aplicarFiltrosComRealce();
    });

    cidadeSelect.addEventListener("change", aplicarFiltrosComRealce);
    mercSelect.addEventListener("change", aplicarFiltrosComRealce);
    nomeInput.addEventListener("input", aplicarFiltrosComRealce);
    endInput.addEventListener("input", aplicarFiltrosComRealce);

    preencherCidades();
  }

  function preencherCidades() {
    const uf = document.getElementById("filtroUF").value;
    const cidadeSelect = document.getElementById("filtroCidade");
    cidadeSelect.innerHTML = '<option value="">Todas</option>';

    const cidades = [...new Set(
      postos.filter(p => !uf || p.uf === uf).map(p => p.cidade)
    )].sort();

    cidades.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      cidadeSelect.appendChild(opt);
    });
  }

  function filtrarPostos() {
    const uf = document.getElementById("filtroUF").value;
    const cidade = document.getElementById("filtroCidade").value;
    const merc = document.getElementById("filtroMerc").value;
    const nome = document.getElementById("filtroNome").value.toLowerCase();
    const endereco = document.getElementById("filtroEndereco").value.toLowerCase();

    return postos.filter(p =>
      (!uf || p.uf === uf) &&
      (!cidade || p.cidade === cidade) &&
      (!merc || p.mercadoria === merc) &&
      (!nome || p.nome.toLowerCase().includes(nome)) &&
      (!endereco || p.endereco.toLowerCase().includes(endereco))
    );
  }

  // ==================== MAPA ====================

  function inicializarMapa() {
    map = L.map("map").setView([-15.78, -47.93], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }

  async function geocodeEndereco(posto) {
    // Se o endereço não tiver número, usa só a rua
    let enderecoBusca = posto.endereco || "";
    if (!/\d/.test(enderecoBusca)) {
      enderecoBusca = enderecoBusca.split(",")[0];
    }

    const chave = `${enderecoBusca}, ${posto.cidade} - ${posto.uf}`;

    if (geocodeCache[chave]) {
      return geocodeCache[chave];
    }

    try {
      const resp = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(chave)}`
      );
      const data = await resp.json();

      if (data && data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        const coord = { lat, lon };
        geocodeCache[chave] = coord;
        return coord;
      }
    } catch (e) {
      console.error("Erro no geocode:", e);
    }

    return null;
  }

  async function atualizarMapa(lista) {
    markersLayer.clearLayers();

    const abaixo = lista.filter(p => p.status === "abaixo");
    if (abaixo.length === 0) return;

    const bounds = [];

    // Limita para não ficar pesado
    const limitados = abaixo.slice(0, 40);

    for (const posto of limitados) {
      const coord = await geocodeEndereco(posto);
      if (!coord) continue;

      const marker = L.circleMarker([coord.lat, coord.lon], {
        radius: 7,
        fillColor: "#22c55e",
        color: "#14532d",
        weight: 2,
        fillOpacity: 0.9,
      }).addTo(markersLayer);

      marker.bindPopup(`
        <strong>${posto.nome}</strong><br>
        ${posto.endereco}<br>
        ${posto.cidade} - ${posto.uf}<br>
        ${posto.desvioNum != null ? `Desvio: ${fmt2(posto.desvioNum)}%<br>` : ""}
        ${posto.precoNum != null ? `Preço: R$ ${fmt2(posto.precoNum)}` : ""}
      `);

      bounds.push([coord.lat, coord.lon]);
    }

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [30, 30] });
    }
  }

  // ==================== LISTA ====================

  function atualizarLista(lista) {
    const container = document.getElementById("listaPostos");
    container.innerHTML = "";

    const filtrados = lista.filter(
      p => p.status === "abaixo" || p.status === "media"
    );

    document.getElementById("countLista").textContent = filtrados.length;

    filtrados.forEach(p => {
      const div = document.createElement("div");
      div.className = "posto-item";

      div.innerHTML = `
        <div class="posto-nome">${p.nome}</div>
        <div class="posto-det">${p.endereco}</div>
        <div class="posto-det">${p.cidade} / ${p.uf}</div>
        ${p.desvioNum != null ? `<div class="posto-det">Desvio: ${fmt2(p.desvioNum)}%</div>` : ""}
        ${p.precoNum != null ? `<div class="posto-det">Preço: R$ ${fmt2(p.precoNum)}</div>` : ""}
      `;

      container.appendChild(div);
    });
  }

  // ==================== TABELA ====================

  function atualizarTabela(lista) {
    const tbody = document.getElementById("tabelaAcima");
    tbody.innerHTML = "";

    const filtrados = lista.filter(
      p => p.status === "acima" || p.status === "muito_acima"
    );

    document.getElementById("countTabela").textContent = filtrados.length;

    filtrados.sort((a, b) => (b.desvioNum || 0) - (a.desvioNum || 0));

    filtrados.forEach(p => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.cidade}/${p.uf}</td>
        <td>${p.desvioNum != null ? fmt2(p.desvioNum) + "%" : ""}</td>
        <td>${p.precoNum != null ? "R$ " + fmt2(p.precoNum) : ""}</td>
        <td>${p.status.replace("_", " ")}</td>
      `;

      tbody.appendChild(tr);
    });
  }

  // ==================== ATUALIZAÇÃO GERAL ====================

  async function atualizarInterface() {
    showLoader(true);
    const filtrados = filtrarPostos();
    atualizarLista(filtrados);
    atualizarTabela(filtrados);
    await atualizarMapa(filtrados);
    showLoader(false);
  }

  async function aplicarFiltrosComRealce() {
    await atualizarInterface();
    highlight(cardLista);
    highlight(cardTabela);
  }
</script>

</body>
</html>
