<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Painel Postos - Alloha Fibra</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #ffffff;
      color: #001059;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    header {
      background: #001059;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      color: white;
    }
    header img {
      height: 45px;
    }

    #sidebar {
      width: 350px;
      background: #f6f8fb;
      padding: 15px;
      overflow-y: auto;
      border-right: 3px solid #001059;
    }

    h2 { margin-top: 0; }

    select, input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: 2px solid #001059;
      font-size: 14px;
    }

    .lista {
      margin-top: 20px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #001059;
      max-height: 40vh;
      overflow-y: auto;
    }

    .item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    .item:last-child { border-bottom: none; }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      color: white;
      font-size: 12px;
    }

    .verde { background: #48EF6C; color:#001059; font-weight:bold; }

    #map {
      flex: 1;
      margin: 20px;
      border-radius: 20px;
      border: 4px solid #001059;
    }
  </style>
</head>

<body>
  <header>
    <img src="logo_alloha_positivo.png" />
    <h1>Painel de Postos - Alloha Fibra</h1>
  </header>

  <div id="sidebar">
    <h2>Filtros</h2>

    <select id="filtroUF"></select>
    <select id="filtroCidade"></select>
    <input type="text" id="filtroPosto" placeholder="Pesquisar por nome" />
    <input type="text" id="filtroEndereco" placeholder="Pesquisar por endereço" />

    <h2>Postos Abaixo da Média</h2>
    <div class="lista" id="listaAbaixo"></div>
  </div>

  <div id="map"></div>

<script>
let dados = [];
let mapa;
let marcadores = [];

async function carregarCSV() {
  const resp = await fetch("postos-mapa.csv");
  const txt = await resp.text();
  const linhas = txt.split("
").map(l => l.split(","));
  const cab = linhas[0];

  dados = linhas.slice(1).map(l => {
    return {
      nome: l[cab.indexOf("Nome EC")],
      cidade: l[cab.indexOf("Cidade EC")],
      uf: l[cab.indexOf("UF EC")],
      endereco: l[cab.indexOf("Logradouro EC")],
      desvio: parseFloat(l[cab.indexOf("Desvio de Preço (%)")]) || 0,
      blacklist: l[cab.indexOf("Blacklist")],
      preco: parseFloat(l[cab.indexOf("Preço por Litro")]) || 0
    };
  });

  dados = dados.filter(d => d.blacklist && d.blacklist.includes("Abaixo"));

  await geocodificarTodos();
  popularFiltros();
  atualizar();
}

async function geocodificarTodos() {
  for (let d of dados) {
    const q = encodeURIComponent(`${d.endereco}, ${d.cidade} - ${d.uf}`);
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${q}`;
    const r = await fetch(url);
    const j = await r.json();
    if (j[0]) {
      d.lat = parseFloat(j[0].lat);
      d.lng = parseFloat(j[0].lon);
    }
  }
}

function popularFiltros() {
  const ufSel = document.getElementById("filtroUF");
  const cidadeSel = document.getElementById("filtroCidade");

  const ufs = [...new Set(dados.map(x => x.uf))].sort();
  ufSel.innerHTML = `<option value="">UF</option>` + ufs.map(u => `<option>${u}</option>`).join("");

  const cidades = [...new Set(dados.map(x => x.cidade))].sort();
  cidadeSel.innerHTML = `<option value="">Cidade</option>` + cidades.map(c => `<option>${c}</option>`).join("");

  ufSel.onchange = atualizar;
  cidadeSel.onchange = atualizar;
  document.getElementById("filtroPosto").onkeyup = atualizar;
  document.getElementById("filtroEndereco").onkeyup = atualizar;
}

function atualizar() {
  const uf = document.getElementById("filtroUF").value;
  const cidade = document.getElementById("filtroCidade").value;
  const p = document.getElementById("filtroPosto").value.toLowerCase();
  const e = document.getElementById("filtroEndereco").value.toLowerCase();

  let filtrados = dados.filter(d =>
    (uf ? d.uf === uf : true) &&
    (cidade ? d.cidade === cidade : true) &&
    (p ? d.nome.toLowerCase().includes(p) : true) &&
    (e ? d.endereco.toLowerCase().includes(e) : true)
  );

  atualizarLista(filtrados);
  atualizarMapa(filtrados);
}

function atualizarLista(lista) {
  const el = document.getElementById("listaAbaixo");
  el.innerHTML = lista.map(d => `
    <div class="item">
      <b>${d.nome}</b><br>
      ${d.endereco}<br>
      <span class="badge verde">Abaixo da média</span><br>
      Preço: R$ ${d.preco.toFixed(2)}<br>
      Desvio: ${d.desvio.toFixed(2)}%
    </div>
  `).join("");
}

function atualizarMapa(lista) {
  marcadores.forEach(m => mapa.removeLayer(m));
  marcadores = [];

  lista.forEach(d => {
    if (d.lat && d.lng) {
      const m = L.marker([d.lat, d.lng]).addTo(mapa).bindPopup(`<b>${d.nome}</b><br>${d.endereco}`);
      marcadores.push(m);
    }
  });

  if (marcadores.length > 0) {
    const g = new L.featureGroup(marcadores);
    mapa.fitBounds(g.getBounds(), { padding: [30, 30] });
  }
}

window.onload = () => {
  mapa = L.map("map").setView([-15.78, -47.93], 4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {}).addTo(mapa);
  carregarCSV();
};
</script>
</body>
</html>
