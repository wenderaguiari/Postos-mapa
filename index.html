<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Postos - Alloha Fibra</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f3f6fb;
      color: #001059;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 260px;
      background: #001059;
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 4px 0 10px rgba(0,0,0,0.25);
    }

    .sidebar-logo img {
      max-width: 150px;
      display: block;
      margin: auto;
    }

    .tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: #48ef6c;
      border: 1px solid #48ef6c;
      background: rgba(72,239,108,0.15);
    }

    .main-panel {
      width: 420px;
      background: #fff;
      padding: 14px 18px;
      border-right: 3px solid #001059;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    h2 { margin: 0 0 4px; }

    select, input[type="text"] {
      width: 100%;
      padding: 8px;
      border-radius: 999px;
      border: 2px solid #001059;
      background: #f9fafb;
      outline: none;
    }

    select:focus, input:focus {
      border-color: #48ef6c;
      box-shadow: 0 0 0 2px rgba(72,239,108,0.25);
      background: white;
    }

    .section-card {
      background: #f9fafb;
      padding: 10px;
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .badge {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 999px;
      font-weight: bold;
    }

    .badge-abaixo { background:#dcfce7; color:#166534; }
    .badge-media { background:#dbeafe; color:#1d4ed8; }
    .badge-acima { background:#fef9c3; color:#854d0e; }
    .badge-muito { background:#fee2e2; color:#b91c1c; }

    .posto-item {
      padding: 6px 4px;
      border-bottom: 1px dashed #ddd;
      cursor: pointer;
    }

    .posto-item:hover { background:#eef; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }
    th {
      background:#001059;
      color:white;
      padding:6px;
    }
    td {
      padding:6px;
      border:1px solid #ddd;
    }
    tr:hover { background:#eef; cursor:pointer; }

    .map-panel {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #001059;
    }

    .loader {
      position: fixed;
      top:50%;
      left:50%;
      width:40px;
      height:40px;
      border:5px solid #ddd;
      border-top:5px solid #48ef6c;
      border-radius:50%;
      transform:translate(-50%,-50%);
      animation:spin 1s infinite linear;
      display:none;
    }

    @keyframes spin { 100% { transform:translate(-50%,-50%) rotate(360deg); } }

  </style>
</head>

<body>
<div class="loader" id="loader"></div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <img src="Imagem1.png" alt="Alloha Fibra">
  </div>
  <div style="font-size:18px; font-weight:600;">Painel de Postos</div>
  <div style="font-size:13px;">Desvio de Preço & Classificação</div>
  <span class="tag">Alloha Frotas</span>
</aside>


<!-- PAINEL CENTRAL -->
<main class="main-panel">

  <h2>Filtros</h2>
  <small>Use os filtros para localizar os postos.</small>

  <label>UF</label>
  <select id="filtroUF"><option value="">Todas</option></select>

  <label>Cidade</label>
  <select id="filtroCidade"><option value="">Todas</option></select>

  <label>Mercadoria</label>
  <select id="filtroMercadoria"><option value="">Todas</option></select>

  <label>Nome</label>
  <input type="text" id="filtroNome">

  <label>Endereço</label>
  <input type="text" id="filtroEndereco">

  <!-- LISTA TOP 10 -->
  <section class="section-card">
    <div class="section-header-title">
      <span class="badge badge-abaixo">Abaixo</span>
      <span class="badge badge-media">Na média</span>
      Top 10 mais baratos
    </div>
    <div id="countLista">(0)</div>
    <div id="listaPostos"></div>
  </section>

  <!-- TABELA ACIMA E MUITO ACIMA -->
  <section class="section-card">
    <div class="section-header-title">
      <span class="badge badge-acima">Acima</span>
      <span class="badge badge-muito">Muito acima</span>
      Desvio crítico
    </div>
    <div id="countTabela">(0)</div>
    <table>
      <thead>
        <tr>
          <th>Posto</th>
          <th>Cidade</th>
          <th>Desvio</th>
          <th>Preço</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tabelaAcima"></tbody>
    </table>
  </section>

</main>


<!-- MAPA -->
<section class="map-panel">
  <div id="map"></div>
</section>
<script>
const CSV_FILE = "postos-mapa.csv";

let postos = [];
let map, markersLayer;

// cache para acelerar o geocode
const geocodeCache =
  JSON.parse(localStorage.getItem("geocodeCachePostos")) || {};

function saveCache() {
  localStorage.setItem(
    "geocodeCachePostos",
    JSON.stringify(geocodeCache)
  );
}

function showLoader(show) {
  const loader = document.getElementById("loader");
  if (!loader) return;
  loader.style.display = show ? "block" : "none";
}

function getCol(row, name) {
  const key = Object.keys(row).find((k) => k.trim() === name);
  return key ? row[key] : "";
}

function parsePreco(v) {
  if (!v) return null;
  let s = String(v).replace(/[R$\s]/g, "");
  if (s.includes(",") && !s.includes(".")) {
    s = s.replace(",", ".");
  }
  const n = parseFloat(s);
  return isNaN(n) ? null : n;
}

function parseDesvio(v) {
  if (!v) return null;
  let s = String(v).replace("%", "").trim();
  if (s.includes(",") && !s.includes(".")) {
    s = s.replace(",", ".");
  }
  const n = parseFloat(s);
  return isNaN(n) ? null : n;
}

function fmt2(n) {
  return n !== null && n !== undefined ? n.toFixed(2) : "";
}

function classificarStatus(blacklist) {
  if (!blacklist) return "desconhecido";
  const s = String(blacklist);
  if (s.includes("Abaixo da média")) return "abaixo";
  if (s.includes("Dentro da média")) return "media";
  if (s.includes("Muito acima")) return "muito_acima";
  if (s.includes("Acima da média")) return "acima";
  return "desconhecido";
}

function pulse(element) {
  if (!element) return;
  element.style.boxShadow = "0 0 0 2px #4ade80";
  setTimeout(() => {
    element.style.boxShadow = "";
  }, 400);
}

/* =============== LEITURA DO CSV =============== */

showLoader(true);

Papa.parse(CSV_FILE, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function (results) {
    postos = results.data
      .map((row) => {
        const nome = getCol(row, "Nome EC");
        const uf = getCol(row, "UF EC");
        const cidade = getCol(row, "Cidade EC");
        const logradouro = getCol(row, "Logradouro EC");
        const mercadoria = getCol(row, "Mercadoria");

        const precoBruto = getCol(row, "Preço por Litro") || getCol(row, " Preço por Litro ");
        const desvioBruto = getCol(row, "Desvio de Preço (%)");
        const blacklist = getCol(row, "Blacklist");

        if (!nome || !uf || !cidade || !logradouro) return null;

        return {
          nome: String(nome).trim(),
          uf: String(uf).trim(),
          cidade: String(cidade).trim(),
          endereco: String(logradouro).trim(),
          mercadoria: String(mercadoria).trim(),
          precoNum: parsePreco(precoBruto),
          desvioNum: parseDesvio(desvioBruto),
          blacklist,
          status: classificarStatus(blacklist),
          _marker: null
        };
      })
      .filter((x) => x !== null);

    inicializarMapa();
    inicializarFiltros();
    atualizarInterface().then(() => showLoader(false));
  },
  error: function () {
    showLoader(false);
  },
});

/* =============== FILTROS =============== */

function inicializarFiltros() {
  const ufSel = document.getElementById("filtroUF");
  const cidSel = document.getElementById("filtroCidade");
  const mercSel = document.getElementById("filtroMercadoria");
  const nomeInp = document.getElementById("filtroNome");
  const endInp = document.getElementById("filtroEndereco");

  // UFs
  const ufs = [...new Set(postos.map((p) => p.uf))].sort();
  ufs.forEach((uf) => {
    const opt = document.createElement("option");
    opt.value = uf;
    opt.textContent = uf;
    ufSel.appendChild(opt);
  });

  // MERCADORIA
  const mercs = [
    ...new Set(
      postos
        .map((p) => p.mercadoria)
        .filter((v) => v && v !== "undefined" && v !== "null")
    ),
  ].sort();

  mercs.forEach((m) => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    mercSel.appendChild(opt);
  });

  ufSel.addEventListener("change", () => {
    preencherCidades();
    aplicarFiltros();
  });
  cidSel.addEventListener("change", aplicarFiltros);
  mercSel.addEventListener("change", aplicarFiltros);
  nomeInp.addEventListener("input", aplicarFiltros);
  endInp.addEventListener("input", aplicarFiltros);

  preencherCidades();
}

function preencherCidades() {
  const uf = document.getElementById("filtroUF").value;
  const cidSel = document.getElementById("filtroCidade");

  cidSel.innerHTML = '<option value="">Todas</option>';

  const cidades = [
    ...new Set(
      postos.filter((p) => !uf || p.uf === uf).map((p) => p.cidade)
    ),
  ].sort();

  cidades.forEach((c) => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    cidSel.appendChild(opt);
  });
}

function filtrarPostos() {
  const uf = document.getElementById("filtroUF").value;
  const cidade = document.getElementById("filtroCidade").value;
  const mercadoria = document.getElementById("filtroMercadoria").value;
  const nome = document.getElementById("filtroNome").value.toLowerCase();
  const endereco = document.getElementById("filtroEndereco").value.toLowerCase();

  return postos.filter((p) => {
    return (
      (!uf || p.uf === uf) &&
      (!cidade || p.cidade === cidade) &&
      (!mercadoria || p.mercadoria === mercadoria) &&
      (!nome || p.nome.toLowerCase().includes(nome)) &&
      (!endereco || p.endereco.toLowerCase().includes(endereco))
    );
  });
}

async function aplicarFiltros() {
  pulse(document.querySelector(".section-card"));
  await atualizarInterface();
}

/* =============== MAPA =============== */

function inicializarMapa() {
  map = L.map("map").setView([-14.5, -51.5], 4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

async function geocodeEndereco(posto) {
  let enderecoBusca = posto.endereco || "";

  // sem número → usa só rua
  if (!/\d/.test(enderecoBusca)) {
    enderecoBusca = enderecoBusca.split(",")[0];
  }

  const chave = `${enderecoBusca}, ${posto.cidade} - ${posto.uf}`;
  if (geocodeCache[chave]) return geocodeCache[chave];

  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(
    chave
  )}`;

  try {
    const resp = await fetch(url, {
      headers: { "Accept-Language": "pt-BR" },
    });
    const data = await resp.json();
    if (data && data.length > 0) {
      const coord = {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon),
      };
      geocodeCache[chave] = coord;
      saveCache();
      return coord;
    }
  } catch (e) {
    console.error("Erro geocode:", e);
  }
  return null;
}

async function atualizarMapa(lista) {
  markersLayer.clearLayers();

  const abaixo = lista.filter((p) => p.status === "abaixo");
  if (abaixo.length === 0) return;

  const limitados = abaixo.slice(0, 20);

  const bounds = [];

  for (const posto of limitados) {
    const coord = await geocodeEndereco(posto);
    if (!coord) continue;

    const marker = L.circleMarker([coord.lat, coord.lon], {
      radius: 7,
      fillColor: "#22c55e",
      color: "#14532d",
      weight: 2,
      fillOpacity: 0.9,
    }).addTo(markersLayer);

    marker.bindPopup(`
      <strong>${posto.nome}</strong><br>
      ${posto.endereco}<br>
      ${posto.cidade} - ${posto.uf}<br>
      Desvio: ${fmt2(posto.desvioNum)}%<br>
      Preço: R$ ${fmt2(posto.precoNum)}
    `);

    posto._marker = marker;
    bounds.push([coord.lat, coord.lon]);
  }

  if (bounds.length > 0) {
    const b = L.latLngBounds(bounds);
    map.fitBounds(b, { padding: [40, 40] });
  }
}

/* =============== LISTA + TABELA =============== */

function atualizarLista(lista) {
  const listaDiv = document.getElementById("listaPostos");
  listaDiv.innerHTML = "";

  const top = lista
    .filter((p) => p.status === "abaixo" || p.status === "media")
    .sort((a, b) => (a.precoNum ?? 999999) - (b.precoNum ?? 999999))
    .slice(0, 10);

  document.getElementById("countLista").textContent = `(${top.length})`;

  top.forEach((p) => {
    const div = document.createElement("div");
    div.className = "posto-item";
    div.innerHTML = `<strong>${p.nome}</strong><br>
      ${p.cidade} - ${p.uf}<br>
      R$ ${fmt2(p.precoNum)} • ${fmt2(p.desvioNum)}%`;

    div.addEventListener("click", () => focarNoMapa(p));

    listaDiv.appendChild(div);
  });
}

function atualizarTabela(lista) {
  const corpo = document.getElementById("tabelaAcima");
  corpo.innerHTML = "";

  const acima = lista.filter(
    (p) => p.status === "acima" || p.status === "muito_acima"
  );

  acima.sort((a, b) => (b.desvioNum ?? 0) - (a.desvioNum ?? 0));

  document.getElementById("countTabela").textContent = `(${acima.length})`;

  acima.forEach((p) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.nome}</td>
      <td>${p.cidade}</td>
      <td>${fmt2(p.desvioNum)}%</td>
      <td>R$ ${fmt2(p.precoNum)}</td>
      <td>${p.status}</td>
    `;
    tr.addEventListener("click", () => focarNoMapa(p));
    corpo.appendChild(tr);
  });
}

/* =============== FOCAR NO MAPA =============== */

function focarNoMapa(posto) {
  if (!posto._marker) return;

  map.setView(posto._marker.getLatLng(), 16, {
    animate: true,
    duration: 0.6,
  });

  posto._marker.openPopup();
}

/* =============== PROCESSO FINAL =============== */

async function atualizarInterface() {
  const filtrados = filtrarPostos();

  atualizarLista(filtrados);
  atualizarTabela(filtrados);
  await atualizarMapa(filtrados);
}
</script>
