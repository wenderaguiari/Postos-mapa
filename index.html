<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Painel de Postos - Alloha Fibra</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- SheetJS - XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #001059;
            color: #fff;
            padding: 20px;
        }

        .main-panel {
            width: 430px;
            padding: 20px;
            background: #fff;
            overflow-y: auto;
        }

        .map-panel {
            flex: 1;
            padding: 20px;
        }

        #map {
            width: 100%;
            height: 90%;
            border-radius: 12px;
        }

        .contador-container {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: #f1f3f8;
            border-bottom: 1px solid #ccc;
        }

        .tag {
            background: #fff;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 13px;
            border: 1px solid #ccc;
        }

        select, input {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            font-size: 13px;
            border-collapse: collapse;
        }

        th, td {
            padding: 6px;
            border: 1px solid #ddd;
        }

    </style>
</head>

<body>

    <!-- CONTADORES NO TOPO -->
    <div class="contador-container" id="topCounters">
        <span class="tag" id="totalPostos">0 postos filtrados</span>
        <span class="tag" id="contAbaixo">Abaixo: 0</span>
        <span class="tag" id="contMedia">Na média: 0</span>
        <span class="tag" id="contAcima">Acima: 0</span>
        <span class="tag" id="contMuito">Muito acima: 0</span>
    </div>

    <!-- MENU LATERAL -->
    <aside class="sidebar">
        <img src="logo_alloha_positivo.png" width="160">
        <h2>Painel de Postos</h2>
        <p>Desvio de Preço & Classificação</p>
    </aside>

    <!-- PAINEL PRINCIPAL -->
    <main class="main-panel">

        <h2>Filtros</h2>

        <label>UF</label>
        <select id="filtroUF"></select>

        <label>Cidade</label>
        <select id="filtroCidade"></select>

        <label>Tipo de Combustível</label>
        <select id="filtroCombustivel"></select>

        <label>Nome do Posto</label>
        <input type="text" id="filtroNome" placeholder="Digite parte do nome">

        <label>Endereço</label>
        <input type="text" id="filtroEndereco" placeholder="Digite parte do logradouro">

        <h3>Abaixo / Média</h3>
        <div id="listaAbaixoMedia"></div>

        <h3>Acima / Muito acima</h3>
        <table>
            <thead>
                <tr>
                    <th>Posto</th>
                    <th>Cidade/UF</th>
                    <th>Comb.</th>
                    <th>Desvio</th>
                    <th>Preço</th>
                    <th>Grupo</th>
                </tr>
            </thead>
            <tbody id="tabelaAcima"></tbody>
        </table>

    </main>

    <!-- MAPA -->
    <section class="map-panel">
        <h3>Mapa – Postos Abaixo da Média</h3>
        <div id="map"></div>
    </section>

    <script>
        const XLSX_FILE = "mapa-postos.xlsx";
        let postos = [];

        let map = L.map("map").setView([-15.78, -47.93], 5);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        let markersLayer = L.layerGroup().addTo(map);

        async function carregarXLSX() {
            try {
                const resp = await fetch(XLSX_FILE);
                if (!resp.ok) throw new Error("Erro HTTP");

                const buf = await resp.arrayBuffer();
                const wb = XLSX.read(buf, { type: "array" });
                const sheet = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(sheet);

                postos = data.map(row => ({
                    nome: row["Nome EC"] || "",
                    uf: row["UF EC"] || "",
                    cidade: row["Cidade EC"] || "",
                    endereco: row["Logradouro EC"] || "",
                    desvio: parseFloat(String(row["Desvio de Preço (%)"]).replace(",", ".")) || 0,
                    preco: parseFloat(String(row[" Preço por Litro "]).replace(",", ".")) || 0,
                    combustivel: row["Mercadoria"] || "",
                    status: classificar(row["Blacklist"])
                }));

                inicializarFiltros();
                atualizarInterface();

            } catch (e) {
                alert("Erro ao ler o XLSX. Verifique se está na mesma pasta do site.");
            }
        }

        function classificar(txt) {
            if (!txt) return "desconhecido";
            txt = txt.toLowerCase();
            if (txt.includes("abaixo")) return "abaixo";
            if (txt.includes("dentro")) return "media";
            if (txt.includes("muito")) return "muito";
            if (txt.includes("acima")) return "acima";
            return "desconhecido";
        }

        function inicializarFiltros() {
            preencherSelect("filtroUF", [...new Set(postos.map(p => p.uf))]);
            preencherSelect("filtroCidade", [...new Set(postos.map(p => p.cidade))]);
            preencherSelect("filtroCombustivel", [...new Set(postos.map(p => p.combustivel))]);
        }

        function preencherSelect(id, lista) {
            const sel = document.getElementById(id);
            sel.innerHTML = "<option value=''>Todos</option>";
            lista.sort().forEach(item => {
                if (item)
                    sel.innerHTML += `<option value="${item}">${item}</option>`;
            });
        }

        function filtrar() {
            const UF = document.getElementById("filtroUF").value;
            const CID = document.getElementById("filtroCidade").value;
            const COMB = document.getElementById("filtroCombustivel").value;
            const NOME = document.getElementById("filtroNome").value.toLowerCase();
            const END = document.getElementById("filtroEndereco").value.toLowerCase();

            return postos.filter(p =>
                (!UF || p.uf === UF) &&
                (!CID || p.cidade === CID) &&
                (!COMB || p.combustivel === COMB) &&
                (!NOME || p.nome.toLowerCase().includes(NOME)) &&
                (!END || p.endereco.toLowerCase().includes(END))
            );
        }

        function atualizarMapa(lista) {
            markersLayer.clearLayers();

            const abaixo = lista.filter(p => p.status === "abaixo");

            abaixo.slice(0, 80).forEach(p => {
                const endereco = `${p.endereco}, ${p.cidade} - ${p.uf}`;
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.length > 0) {
                            const lat = data[0].lat;
                            const lon = data[0].lon;

                            L.marker([lat, lon]).addTo(markersLayer)
                                .bindPopup(`
                                    <strong>${p.nome}</strong><br>
                                    ${p.endereco}<br>
                                    ${p.cidade}/${p.uf}<br>
                                    Desvio: ${p.desvio}%<br>
                                    Preço: R$ ${p.preco}
                                `);
                        }
                    });
        });
        }

        function atualizarInterface() {
            const lista = filtrar();

            document.getElementById("totalPostos").textContent = lista.length + " postos filtrados";
            document.getElementById("contAbaixo").textContent = "Abaixo: " + lista.filter(p => p.status === "abaixo").length;
            document.getElementById("contMedia").textContent = "Na média: " + lista.filter(p => p.status === "media").length;
            document.getElementById("contAcima").textContent = "Acima: " + lista.filter(p => p.status === "acima").length;
            document.getElementById("contMuito").textContent = "Muito acima: " + lista.filter(p => p.status === "muito").length;

            atualizarTabela(lista);
            atualizarLista(lista);
            atualizarMapa(lista);
        }

        function atualizarLista(lista) {
            const el = document.getElementById("listaAbaixoMedia");
            el.innerHTML = "";

            lista.filter(p => p.status === "abaixo" || p.status === "media")
                .forEach(p => {
                    el.innerHTML += `
                        <div>
                            <strong>${p.nome}</strong> - ${p.cidade}/${p.uf}
                            <br>${p.endereco}
                        </div><hr>
                    `;
                });
        }

        function atualizarTabela(lista) {
            const tb = document.getElementById("tabelaAcima");
            tb.innerHTML = "";

            lista.filter(p => p.status === "acima" || p.status === "muito")
                .forEach(p => {
                    tb.innerHTML += `
                        <tr>
                            <td>${p.nome}</td>
                            <td>${p.cidade}/${p.uf}</td>
                            <td>${p.combustivel}</td>
                            <td>${p.desvio}%</td>
                            <td>R$ ${p.preco}</td>
                            <td>${p.status}</td>
                        </tr>
                    `;
                });
        }

        carregarXLSX();
    </script>

</body>
</html>
