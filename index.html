<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Postos - Alloha Fibra</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f3f6fb;
      color: #001059;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #001059;
      color: #f9fafb;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 4px 0 10px rgba(0,0,0,0.25);
      z-index: 10;
    }

    .sidebar-logo { display: flex; justify-content: center; margin-bottom: 10px; }
    .sidebar-logo img { max-width: 160px; height: auto; }

    .sidebar-title-main { font-size: 18px; font-weight: 600; }
    .sidebar-title-sub { font-size: 13px; opacity: 0.9; }
    .sidebar-info { font-size: 11px; opacity: 0.8; margin-top: 8px; }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #48ef6c;
      color: #48ef6c;
      background: rgba(72,239,108,0.15);
      margin-top: 6px;
    }

    /* Painel central */
    .main-panel {
      width: 420px;
      background: #ffffff;
      padding: 16px 18px;
      border-right: 3px solid #001059;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
    }

    .main-panel h2 { margin: 0 0 4px; font-size: 16px; }
    .main-panel small { color: #6b7280; font-size: 11px; }

    .filtros {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
      color: #111827;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 2px solid #001059;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    }

    select:focus, input[type="text"]:focus {
      border-color: #48ef6c;
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(72,239,108,0.25);
    }

    .section-card {
      margin-top: 12px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 6px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.08);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .section-header-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-count { font-size: 11px; color: #6b7280; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .badge-abaixo { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .badge-media { background: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; }
    .badge-acima { background: #fef9c3; color: #854d0e; border: 1px solid #facc15; }
    .badge-muito { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

    .lista-postos {
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .posto-item { padding: 6px 2px; border-bottom: 1px dashed #e5e7eb; font-size: 12px; }
    .posto-item:last-child { border-bottom: none; }
    .posto-nome { font-weight: 600; color: #111827; }
    .posto-det { font-size: 11px; color: #6b7280; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 6px;
    }
    table thead { background: #001059; color: #f9fafb; }
    th, td { padding: 6px 4px; border: 1px solid #e5e7eb; text-align:left; }

    .map-panel {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-card {
      flex: 1;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(15,23,42,0.1);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #map { flex: 1; border-radius: 12px; overflow: hidden; }

    .loader {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      border: 5px solid #e5e7eb;
      border-top: 5px solid #48ef6c;
      border-radius: 50%;
      width: 34px; height: 34px;
      animation: spin 1s linear infinite;
      display: none;
      z-index: 999;
    }

    @keyframes spin { 0%{transform:translate(-50%,-50%) rotate(0deg);} 100%{transform:translate(-50%,-50%) rotate(360deg);} }
  </style>
</head>

<body>
  <div class="loader" id="loader"></div>

  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="Imagem1.png" alt="Alloha Fibra">
    </div>

    <div>
      <div class="sidebar-title-main">Painel de Postos</div>
      <div class="sidebar-title-sub">Desvio de Preço & Classificação</div>
      <div id="contadorBlacklist" class="sidebar-info">
        Carregando...
      </div>
      <span class="tag">Alloha Frotas · Uso interno</span>
    </div>
  </aside>

  <main class="main-panel">

    <section>
      <h2>Filtros</h2>
      <small>Filtre por UF, Cidade, Nome, Endereço e Mercadoria.</small>

      <div class="filtros">

        <div>
          <label for="filtroUF">UF</label>
          <select id="filtroUF"><option value="">Todas</option></select>
        </div>

        <div>
          <label for="filtroCidade">Cidade</label>
          <select id="filtroCidade"><option value="">Todas</option></select>
        </div>

        <div>
          <label for="filtroComb">Mercadoria</label>
          <select id="filtroComb"><option value="">Todos</option></select>
        </div>

        <div>
          <label for="filtroNome">Nome do posto</label>
          <input type="text" id="filtroNome" placeholder="Digite parte do nome">
        </div>

        <div>
          <label for="filtroEndereco">Endereço</label>
          <input type="text" id="filtroEndereco" placeholder="Digite parte do endereço">
        </div>

      </div>
    </section>
    <!-- LISTA ABAIXO / MÉDIA -->
    <section class="section-card">
      <div class="section-header">
        <div class="section-header-title">
          <span class="badge badge-abaixo">Abaixo</span>
          <span class="badge badge-media">Na média</span>
          Postos aceitáveis ou melhores
        </div>
        <div id="countLista" class="section-count">(0)</div>
      </div>
      <div id="listaPostos" class="lista-postos"></div>
    </section>

    <!-- TABELA ACIMA / MUITO ACIMA -->
    <section class="section-card">
      <div class="section-header">
        <div class="section-header-title">
          <span class="badge badge-acima">Acima</span>
          <span class="badge badge-muito">Muito acima</span>
          Postos com desvio crítico
        </div>
        <div id="countTabela" class="section-count">(0)</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Posto</th>
            <th>Cidade/UF</th>
            <th>Desvio (%)</th>
            <th>Preço (R$)</th>
            <th>Mercadoria</th>
            <th>Grupo</th>
          </tr>
        </thead>
        <tbody id="tabelaAcima"></tbody>
      </table>
    </section>

  </main>

  <!-- MAPA -->
  <section class="map-panel">
    <div class="map-card">
      <div class="map-header">
        <div>Mapa – Postos abaixo da média</div>
        <span>Somente postos abaixo da média aparecem no mapa.</span>
      </div>
      <div id="map"></div>
    </div>
  </section>

  <!-- ======================= JAVASCRIPT ========================= -->

  <script>
    const CSV_FILE = "postos-mapa.csv";
    const loader = document.getElementById("loader");

    let postos = [];
    let map, markersLayer;
    const geocodeCache = {};

    function showLoader(show) {
      loader.style.display = show ? "block" : "none";
    }

    function getCol(row, name) {
      const key = Object.keys(row).find(k => k.trim() === name);
      return key ? row[key] : "";
    }

    function parsePreco(v) {
      if (!v) return null;
      let s = String(v).replace(/[R$\s]/g, "");
      if (s.includes(",") && !s.includes(".")) s = s.replace(",", ".");
      return isNaN(parseFloat(s)) ? null : parseFloat(s);
    }

    function parseDesvio(v) {
      if (!v) return null;
      let s = String(v).replace("%", "");
      if (s.includes(",") && !s.includes(".")) s = s.replace(",", ".");
      return isNaN(parseFloat(s)) ? null : parseFloat(s);
    }

    function fmt2(n) {
      return n != null ? n.toFixed(2) : "";
    }

    function classificarStatus(s) {
      if (!s) return "desconhecido";
      if (s.includes("Abaixo")) return "abaixo";
      if (s.includes("Dentro") || s.includes("Média")) return "media";
      if (s.includes("Muito acima")) return "muito_acima";
      if (s.includes("Acima")) return "acima";
      return "desconhecido";
    }

    // ====================== LER CSV ======================
    showLoader(true);

    Papa.parse(CSV_FILE, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: results => {
        postos = results.data.map(row => {
          const nome = getCol(row, "Nome EC");
          const uf = getCol(row, "UF EC");
          const cidade = getCol(row, "Cidade EC");
          const endereco = getCol(row, "Logradouro EC");
          const mercadoria = getCol(row, "Combustível");
          const blacklist = getCol(row, "Blacklist");

          if (!nome || !uf || !cidade || !endereco || !mercadoria) return null;

          return {
            nome: nome.trim(),
            uf: uf.trim(),
            cidade: cidade.trim(),
            endereco: endereco.trim(),
            combustivel: mercadoria.trim(),
            desvioNum: parseDesvio(getCol(row, "Desvio de Preço (%)")),
            precoNum: parsePreco(getCol(row, "Preço por Litro")),
            status: classificarStatus(blacklist),
            blacklist: blacklist
          };
        }).filter(x => x);

        inicializarMapa();
        inicializarFiltros();
        atualizarContadorBlacklist();
        atualizarInterface().then(() => showLoader(false));
      }
    });

    // ==================== FILTROS ====================

    function inicializarFiltros() {
      const ufSelect = document.getElementById("filtroUF");
      const cidadeSelect = document.getElementById("filtroCidade");
      const nomeInput = document.getElementById("filtroNome");
      const endInput = document.getElementById("filtroEndereco");
      const mercaSelect = document.getElementById("filtroComb");

      const ufs = [...new Set(postos.map(p => p.uf))].sort();
      ufs.forEach(uf => {
        const opt = document.createElement("option");
        opt.value = uf;
        opt.textContent = uf;
        ufSelect.appendChild(opt);
      });

      const marcadoria = [...new Set(postos.map(p => p.mercadoria))].sort();
      combustiveis.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        combSelect.appendChild(opt);
      });

      ufSelect.addEventListener("change", () => { preencherCidades(); atualizarInterface(); });
      cidadeSelect.addEventListener("change", atualizarInterface);
      nomeInput.addEventListener("input", atualizarInterface);
      endInput.addEventListener("input", atualizarInterface);
      combSelect.addEventListener("change", atualizarInterface);

      preencherCidades();
    }

    function preencherCidades() {
      const uf = document.getElementById("filtroUF").value;
      const cidadeSelect = document.getElementById("filtroCidade");
      cidadeSelect.innerHTML = '<option value="">Todas</option>';

      const cidades = [...new Set(postos.filter(p => !uf || p.uf === uf).map(p => p.cidade))].sort();
      cidades.forEach(cidade => {
        const opt = document.createElement("option");
        opt.value = cidade;
        opt.textContent = cidade;
        cidadeSelect.appendChild(opt);
      });
    }

    function filtrarPostos() {
      const uf = document.getElementById("filtroUF").value;
      const cidade = document.getElementById("filtroCidade").value;
      const nome = document.getElementById("filtroNome").value.toLowerCase();
      const endereco = document.getElementById("filtroEndereco").value.toLowerCase();
      const merca = document.getElementById("filtroComb").value;

      return postos.filter(p =>
        (!uf || p.uf === uf) &&
        (!cidade || p.cidade === cidade) &&
        (!merca || p.mercadoria === merca) &&
        (!nome || p.nome.toLowerCase().includes(nome)) &&
        (!endereco || p.endereco.toLowerCase().includes(endereco))
      );
    }

    // =============== CONTADOR BLACKLIST =================
    function atualizarContadorBlacklist() {
      const cont = { abaixo: 0, media: 0, acima: 0, muito_acima: 0 };

      postos.forEach(p => {
        if (cont[p.status] !== undefined) cont[p.status]++;
      });

      document.getElementById("contadorBlacklist").innerHTML = `
        <strong>Abaixo:</strong> ${cont.abaixo} ·
        <strong>Média:</strong> ${cont.media} ·
        <strong>Acima:</strong> ${cont.acima} ·
        <strong>Muito acima:</strong> ${cont.muito_acima}
      `;
    }

    // =============== MAPA ======================
    function inicializarMapa() {
      map = L.map("map").setView([-15.78, -47.93], 4);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    async function geocodeEndereco(posto) {
      const chave = `${posto.endereco}, ${posto.cidade} - ${posto.uf}`;
      if (geocodeCache[chave]) return geocodeCache[chave];

      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(chave)}`;

      try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          geocodeCache[chave] = { lat, lon };
          return geocodeCache[chave];
        }
      } catch(e){}

      return null;
    }

    async function atualizarMapa(lista) {
      markersLayer.clearLayers();
      const abaixo = lista.filter(p => p.status === "abaixo");
      if (abaixo.length === 0) return;

      const bounds = [];

      for (const posto of abaixo.slice(0,80)) {
        const coord = await geocodeEndereco(posto);
        if (!coord) continue;

        const marker = L.circleMarker([coord.lat, coord.lon], {
          radius: 7,
          fillColor: "#22c55e",
          color: "#14532d",
          weight: 2,
          fillOpacity: 0.9,
        }).addTo(markersLayer);

        marker.bindPopup(`
          <strong>${posto.nome}</strong><br>
          ${posto.endereco}<br>
          ${posto.cidade} - ${posto.uf}<br>
          Combustível: ${posto.combustivel}<br>
          Desvio: ${fmt2(posto.desvioNum)}%<br>
          Preço: R$ ${fmt2(posto.precoNum)}
        `);

        bounds.push([coord.lat, coord.lon]);
      }

      if (bounds.length > 0) map.fitBounds(bounds, { padding: [30,30] });
    }

    // =============== LISTA =======================
    function atualizarLista(lista) {
      const container = document.getElementById("listaPostos");
      container.innerHTML = "";

      const filtrados = lista.filter(p =>
        p.status === "abaixo" || p.status === "media"
      );

      document.getElementById("countLista").textContent = `(${filtrados.length})`;

      filtrados.forEach(p => {
        const div = document.createElement("div");
        div.className = "posto-item";

        div.innerHTML = `
          <div class="posto-nome">${p.nome}</div>
          <div class="posto-det">${p.endereco}</div>
          <div class="posto-det">${p.cidade} / ${p.uf}</div>
          <div class="posto-det">Combustível: ${p.combustivel}</div>
          <div class="posto-det">Desvio: ${fmt2(p.desvioNum)}%</div>
          <div class="posto-det">Preço: R$ ${fmt2(p.precoNum)}</div>
        `;

        container.appendChild(div);
      });
    }

    // =============== TABELA =======================
    function atualizarTabela(lista) {
      const tbody = document.getElementById("tabelaAcima");
      tbody.innerHTML = "";

      const filtrados = lista.filter(
        p => p.status === "acima" || p.status === "muito_acima"
      );

      document.getElementById("countTabela").textContent = `(${filtrados.length})`;

      filtrados.sort((a,b)=>(b.desvioNum||0)-(a.desvioNum||0));

      filtrados.forEach(p => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${p.nome}</td>
          <td>${p.cidade}/${p.uf}</td>
          <td>${fmt2(p.desvioNum)}%</td>
          <td>${p.precoNum ? "R$ " + fmt2(p.precoNum) : ""}</td>
          <td>${p.combustivel}</td>
          <td>${p.status.replace("_"," ")}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    // =============== ATUALIZAÇÃO GERAL ======================
    async function atualizarInterface() {
      showLoader(true);

      const filtrados = filtrarPostos();
      atualizarLista(filtrados);
      atualizarTabela(filtrados);
      await atualizarMapa(filtrados);

      showLoader(false);
    }

  </script>

</body>
</html>

