<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Postos - Alloha Fibra</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f3f6fb;
      color: #001059;
      display: flex;
      height: 100vh;
      overflow: hidden;
      padding-top: 60px; /* espaço p/ contadores */
    }

    /* CONTADORES DO TOPO */
    #topCounters {
      width: 100%;
      background: #ffffff;
      padding: 10px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 2px solid #001059;
      font-family: 'Segoe UI', Arial, sans-serif;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 40;
    }

    .tc-item {
      background: #f3f4f6;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid #d1d5db;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px;
      background: #001059;
      color: #f9fafb;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 4px 0 10px rgba(0,0,0,0.25);
      z-index: 10;
    }

    .sidebar-logo { display: flex; justify-content: center; }
    .sidebar-logo img { max-width: 160px; }

    .sidebar-title-main { font-size: 18px; font-weight: 600; }
    .sidebar-title-sub { font-size: 13px; opacity: 0.9; }
    .sidebar-info { font-size: 11px; opacity: 0.8; }

    .tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #48ef6c;
      color: #48ef6c;
      background: rgba(72,239,108,0.15);
    }

    /* PAINEL CENTRAL */
    .main-panel {
      width: 420px;
      background: #ffffff;
      padding: 16px 18px;
      border-right: 3px solid #001059;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
    }

    label { font-size: 12px; font-weight: 600; margin-bottom: 3px; color: #111827; }

    select, input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 2px solid #001059;
      background: #f9fafb;
      font-size: 13px;
    }

    select:focus, input:focus {
      border-color: #48ef6c;
      background: #fff;
      box-shadow: 0 0 0 2px rgba(72,239,108,0.25);
    }

    .filtros { display: flex; flex-direction: column; gap: 10px; }

    /* LISTAS E TABELAS */
    .section-card {
      margin-top: 12px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 6px;
    }

    table thead {
      background: #001059;
      color: #f9fafb;
    }

    th, td {
      padding: 6px 4px;
      border: 1px solid #e5e7eb;
      text-align: left;
    }

    /* MAPA */
    .map-panel {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .map-card {
      flex: 1;
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 10px;
    }

    #map { flex: 1; border-radius: 12px; }
  </style>
</head>

<body>

<!-- CONTADORES -->
<div id="topCounters">
  <span class="tc-item" id="tc-total"></span>
  <span class="tc-item" id="tc-bloq"></span>
  <span class="tc-item" id="tc-abaixo"></span>
  <span class="tc-item" id="tc-media"></span>
  <span class="tc-item" id="tc-acima"></span>
  <span class="tc-item" id="tc-muito"></span>
</div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo"><img src="Imagem1.png"></div>
  <div>
    <div class="sidebar-title-main">Painel de Postos</div>
    <div class="sidebar-title-sub">Desvio de Preço & Classificação</div>
    <div class="sidebar-info">
      Foco em <strong>postos abaixo da média</strong> no mapa.
    </div>
    <span class="tag">Alloha Frotas · Uso interno</span>
  </div>
</aside>

<!-- PAINEL CENTRAL -->
<main class="main-panel">

  <h2>Filtros</h2>
  <small>Use para localizar rapidamente os postos.</small>

  <div class="filtros">

    <div>
      <label>UF</label>
      <select id="filtroUF"><option value="">Todas</option></select>
    </div>

    <div>
      <label>Cidade</label>
      <select id="filtroCidade"><option value="">Todas</option></select>
    </div>

    <div>
      <label>Tipo de Combustível</label>
      <select id="filtroComb"><option value="">Todos</option></select>
    </div>

    <div>
      <label>Nome do posto</label>
      <input type="text" id="filtroNome">
    </div>

    <div>
      <label>Endereço</label>
      <input type="text" id="filtroEndereco">
    </div>
  </div>

  <!-- LISTA ABAIXO E NA MÉDIA -->
  <section class="section-card">
    <div class="section-header">
      <strong>Abaixo / Média</strong>
      <span id="countLista">(0)</span>
    </div>
    <div id="listaPostos"></div>
  </section>

  <!-- TABELA ACIMA E MUITO ACIMA -->
  <section class="section-card">
    <div class="section-header">
      <strong>Acima / Muito acima</strong>
      <span id="countTabela">(0)</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Posto</th>
          <th>Cidade/UF</th>
          <th>Comb.</th>
          <th>Desvio</th>
          <th>Preço</th>
          <th>Grupo</th>
        </tr>
      </thead>
      <tbody id="tabelaAcima"></tbody>
    </table>
  </section>
</main>

<!-- MAPA -->
<section class="map-panel">
  <div class="map-card">
    <h3>Mapa – Postos abaixo da média</h3>
    <div id="map"></div>
  </div>
</section>


<script>
const CSV_FILE = "postos-mapa.csv";
let postos = [];
let map, markersLayer;

function classificar(black) {
  if (!black) return "desconhecido";
  if (black.includes("Abaixo")) return "abaixo";
  if (black.includes("Dentro")) return "media";
  if (black.includes("Acima da média")) return "acima";
  if (black.includes("Muito acima")) return "muito";
  return "desconhecido";
}

Papa.parse(CSV_FILE, {
  download: true,
  header: true,
  complete: (res) => {
    postos = res.data.map(r => ({
      nome: r["Nome EC"],
      uf: r["UF EC"],
      cidade: r["Cidade EC"],
      endereco: r["Logradouro EC"],
      combustivel: r["Combustível"] || "",
      blacklist: r["Blacklist"],
      preco: parseFloat((r["Preço por Litro"]+"").replace(",", ".")) || null,
      desvio: parseFloat((r["Desvio de Preço (%)"]+"").replace("%","").replace(",", ".")) || null,
      status: classificar(r["Blacklist"])
    })).filter(x => x.nome);

    inicializarFiltros();
    inicializarMapa();
    atualizarInterface();
  }
});

function inicializarMapa() {
  map = L.map("map").setView([-15.78, -47.93], 4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

function inicializarFiltros() {
  const ufSel = document.getElementById("filtroUF");
  const cidSel = document.getElementById("filtroCidade");
  const combSel = document.getElementById("filtroComb");

  [...new Set(postos.map(p => p.uf))].sort().forEach(u => {
    ufSel.innerHTML += `<option>${u}</option>`;
  });

  [...new Set(postos.map(p => p.cidade))].sort().forEach(c => {
    cidSel.innerHTML += `<option>${c}</option>`;
  });

  [...new Set(postos.map(p => p.combustivel))].sort().forEach(c => {
    if (c) combSel.innerHTML += `<option>${c}</option>`;
  });

  document.querySelectorAll("#filtroUF,#filtroCidade,#filtroComb,#filtroNome,#filtroEndereco")
    .forEach(el => el.addEventListener("input", atualizarInterface));
}

function filtrar() {
  const uf = filtroUF.value;
  const cid = filtroCidade.value;
  const comb = filtroComb.value;
  const nome = filtroNome.value.toLowerCase();
  const end = filtroEndereco.value.toLowerCase();

  return postos.filter(p =>
    (!uf || p.uf === uf) &&
    (!cid || p.cidade === cid) &&
    (!comb || p.combustivel === comb) &&
    (!nome || p.nome.toLowerCase().includes(nome)) &&
    (!end || p.endereco.toLowerCase().includes(end))
  );
}

function atualizarContadores(lista) {
  document.getElementById("tc-total").textContent = `${lista.length} postos filtrados`;
  document.getElementById("tc-bloq").textContent  = `Bloqueados: 0`;
  document.getElementById("tc-abaixo").textContent = `Abaixo: ${lista.filter(p=>p.status==="abaixo").length}`;
  document.getElementById("tc-media").textContent  = `Na média: ${lista.filter(p=>p.status==="media").length}`;
  document.getElementById("tc-acima").textContent  = `Acima: ${lista.filter(p=>p.status==="acima").length}`;
  document.getElementById("tc-muito").textContent  = `Muito acima: ${lista.filter(p=>p.status==="muito").length}`;
}

async function atualizarMapa(lista) {
  markersLayer.clearLayers();
  const abaixo = lista.filter(p => p.status === "abaixo").slice(0,80);
  const bounds = [];

  for (let p of abaixo) {
    const q = encodeURIComponent(`${p.endereco}, ${p.cidade} - ${p.uf}`);
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${q}`;

    const r = await fetch(url);
    const js = await r.json();
    if (!js[0]) continue;

    const lat = js[0].lat, lon = js[0].lon;
    L.circleMarker([lat, lon], { radius: 7, color:"#14532d", fillColor:"#22c55e", fillOpacity:0.9 })
      .addTo(markersLayer)
      .bindPopup(`<strong>${p.nome}</strong><br>${p.endereco}<br>${p.cidade}/${p.uf}`);

    bounds.push([lat, lon]);
  }

  if (bounds.length) map.fitBounds(bounds);
}

function atualizarLista(lista) {
  const box = document.getElementById("listaPostos");
  box.innerHTML = "";
  const arr = lista.filter(p => p.status==="abaixo" || p.status==="media");
  document.getElementById("countLista").textContent = `(${arr.length})`;

  arr.forEach(p=>{
    box.innerHTML += `
      <div style="border-bottom:1px dashed #ccc; padding:5px;">
        <strong>${p.nome}</strong><br>
        ${p.endereco}<br>
        ${p.cidade}/${p.uf}<br>
        Comb.: ${p.combustivel}<br>
        Desvio: ${p.desvio}% | Preço: R$ ${p.preco}
      </div>`;
  });
}

function atualizarTabela(lista) {
  const tbody = document.getElementById("tabelaAcima");
  tbody.innerHTML = "";
  const arr = lista.filter(p => p.status==="acima" || p.status==="muito")
                   .sort((a,b)=> (b.desvio || 0) - (a.desvio || 0));

  document.getElementById("countTabela").textContent = `(${arr.length})`;

  arr.forEach(p=>{
    tbody.innerHTML += `
      <tr>
        <td>${p.nome}</td>
        <td>${p.cidade}/${p.uf}</td>
        <td>${p.combustivel}</td>
        <td>${p.desvio}%</td>
        <td>R$ ${p.preco}</td>
        <td>${p.status}</td>
      </tr>`;
  });
}

async function atualizarInterface() {
  const filtrados = filtrar();
  atualizarContadores(filtrados);
  atualizarLista(filtrados);
  atualizarTabela(filtrados);
  atualizarMapa(filtrados);
}
</script>

</body>
</html>
