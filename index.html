<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel de Postos - Alloha Fibra</title>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<style>
    body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #F3F6FB;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }

    /* Sidebar Azul */
    .sidebar {
        width: 300px;
        background: #001059;
        color: white;
        padding: 30px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .sidebar img {
        width: 150px;
        margin-bottom: 20px;
    }

    .sidebar h1 {
        font-size: 22px;
        margin: 0;
    }

    /* Área de filtros e lista */
    .filters {
        width: 350px;
        background: #FFFFFF;
        border-right: 3px solid #001059;
        padding: 25px;
        overflow-y: auto;
    }

    label {
        font-weight: bold;
        color: #001059;
        margin-top: 10px;
        display: block;
    }

    select, input {
        width: 100%;
        padding: 10px;
        border: 2px solid #001059;
        border-radius: 8px;
        margin-top: 5px;
        outline: none;
    }

    #listaPostos {
        margin-top: 20px;
        padding: 0;
        list-style: none;
    }

    .postoItem {
        background: #F3F6FB;
        padding: 10px;
        margin-bottom: 10px;
        border-left: 5px solid #001059;
        border-radius: 6px;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: bold;
        color: white;
    }

    .acima { background: #E53935; }
    .abaixo { background: #43A047; }
    .media { background: #1E88E5; }
    .bloqueado { background: #555; }

    /* MAPA */
    #map {
        flex: 1;
        height: 100vh;
        border-left: 3px solid #001059;
        border-radius: 20px;
        margin: 15px;
    }

    /* Responsividade */
    @media (max-width: 900px) {
        body { flex-direction: column; }
        .sidebar { width: 100%; height: auto; text-align: center; }
        .filters { width: 100%; border-right: none; border-top: 3px solid #001059; }
        #map { height: 400px; }
    }
</style>
</head>

<body>

<!-- BARRA LATERAL -->
<div class="sidebar">
    <img src="logo_alloha_positivo.png">
    <h1>Painel de Postos</h1>
    <p>Alloha Fibra</p>
</div>

<!-- FILTROS -->
<div class="filters">
    <h2 style="color:#001059;">Filtros</h2>

    <label>UF</label>
    <select id="filtroUF"></select>

    <label>Cidade</label>
    <select id="filtroCidade"></select>

    <label>Pesquisar por nome</label>
    <input type="text" id="filtroNome" placeholder="Digite o nome">

    <label>Pesquisar por endereço</label>
    <input type="text" id="filtroEndereco" placeholder="Digite o endereço">

    <h2 style="margin-top:20px;color:#001059;">Postos</h2>
    <ul id="listaPostos"></ul>
</div>

<!-- MAPA -->
<div id="map"></div>

<script>
let mapa = L.map('map').setView([-14.2, -51.9], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
}).addTo(mapa);

let marcadores = [];
let dadosCSV = [];

/* ==== LER O CSV DO REPOSITÓRIO ==== */
fetch("postos-mapa.csv")
    .then(res => res.text())
    .then(csv => processarCSV(csv));

/* PARSE CSV */
function processarCSV(texto) {
    const linhas = texto.split("\n").slice(1);

    dadosCSV = linhas.map(l => {
        const c = l.split(",");

        return {
            nome: c[0],
            endereco: c[1],
            cidade: c[2],
            uf: c[3],
            media: parseFloat(c[4]),
            preco: parseFloat(c[5]),
            status: c[6], // acima / abaixo / media / bloqueado
            lat: parseFloat(c[7]),
            lng: parseFloat(c[8])
        };
    });

    preencherFiltros();
    atualizarInterface();
}

/* FILTROS DINÂMICOS */
function preencherFiltros() {
    let estados = [...new Set(dadosCSV.map(p => p.uf))].sort();
    let cidades = [...new Set(dadosCSV.map(p => p.cidade))].sort();

    const filtroUF = document.getElementById("filtroUF");
    const filtroCidade = document.getElementById("filtroCidade");

    filtroUF.innerHTML = "<option value=''>Todos</option>";
    estados.forEach(uf => filtroUF.innerHTML += `<option>${uf}</option>`);

    filtroCidade.innerHTML = "<option value=''>Todas</option>";
    cidades.forEach(c => filtroCidade.innerHTML += `<option>${c}</option>`);

    filtroUF.onchange =
    filtroCidade.onchange =
    document.getElementById("filtroNome").oninput =
    document.getElementById("filtroEndereco").oninput =
        atualizarInterface;
}

/* APLICAR FILTROS */
function atualizarInterface() {

    let uf = filtroUF.value;
    let cidade = filtroCidade.value.toLowerCase();
    let nome = filtroNome.value.toLowerCase();
    let end = filtroEndereco.value.toLowerCase();

    let filtrados = dadosCSV.filter(p =>
        (uf === "" || p.uf === uf) &&
        (cidade === "" || p.cidade.toLowerCase().includes(cidade)) &&
        (nome === "" || p.nome.toLowerCase().includes(nome)) &&
        (end === "" || p.endereco.toLowerCase().includes(end))
    );

    atualizarLista(filtrados);
    atualizarMapa(filtrados);
}

/* LISTA LATERAL */
function atualizarLista(lista) {
    const ul = document.getElementById("listaPostos");
    ul.innerHTML = "";

    lista.forEach(p => {
        let cor = p.status === "acima" ? "acima" :
                  p.status === "abaixo" ? "abaixo" :
                  p.status === "media" ? "media" : "bloqueado";

        ul.innerHTML += `
            <li class="postoItem">
                <strong>${p.nome}</strong><br>
                ${p.endereco}<br>
                <span class="badge ${cor}">${p.status.toUpperCase()}</span>
            </li>
        `;
    });
}

/* MAPA */
function atualizarMapa(lista) {
    marcadores.forEach(m => mapa.removeLayer(m));
    marcadores = [];

    lista.forEach(p => {
        if (!p.lat || !p.lng) return;

        let cor = p.status === "acima" ? "red" :
                  p.status === "abaixo" ? "green" :
                  p.status === "media" ? "blue" : "gray";

        let marker = L.circleMarker([p.lat, p.lng], {
            radius: 8,
            fillColor: cor,
            color: "#001059",
            weight: 2,
            fillOpacity: 0.8
        }).addTo(mapa);

        marker.bindPopup(`
            <strong>${p.nome}</strong><br>
            ${p.endereco}<br>
            Cidade: ${p.cidade} - ${p.uf}<br>
            Preço: R$ ${p.preco.toFixed(2)}<br>
            Média: R$ ${p.media.toFixed(2)}<br>
            <span style="color:${cor};font-weight:bold">${p.status.toUpperCase()}</span>
        `);

        marcadores.push(marker);
    });
}

</script>
</body>
</html>
