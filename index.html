<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Postos - Alloha Fibra</title>

  <!-- Leaflet (Mapa) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SheetJS (leitura XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f3f6fb;
      color: #001059;
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow: hidden;
      padding-top: 48px; /* espaço pros contadores */
    }

    /* Barra superior de contadores */
    .top-summary {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 42px;
      background: #ffffff;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 16px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
      z-index: 30;
      font-size: 12px;
      color: #111827;
    }

    .top-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f4ff;
      border: 1px solid #e5e7eb;
      white-space: nowrap;
    }

    .top-pill span.num {
      font-weight: 700;
      color: #001059;
    }

    /* Layout principal */
    .sidebar {
      width: 260px;
      background: #001059;
      color: #f9fafb;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.25);
      z-index: 10;
    }

    .sidebar-logo {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }

    .sidebar-logo img {
      max-width: 160px;
      height: auto;
    }

    .sidebar-title-main {
      font-size: 18px;
      font-weight: 600;
    }

    .sidebar-title-sub {
      font-size: 13px;
      opacity: 0.9;
    }

    .sidebar-info {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 8px;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #48ef6c;
      color: #48ef6c;
      background: rgba(72, 239, 108, 0.15);
      margin-top: 6px;
    }

    /* Área do meio (filtros + listas + tabela) */
    .main-panel {
      width: 420px;
      background: #ffffff;
      padding: 16px 18px;
      border-right: 3px solid #001059;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
    }

    .main-panel h2 {
      margin: 0 0 4px;
      font-size: 16px;
    }

    .main-panel small {
      color: #6b7280;
      font-size: 11px;
    }

    .filtros {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
      color: #111827;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 2px solid #001059;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: #48ef6c;
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(72, 239, 108, 0.25);
    }

    .section-card {
      margin-top: 12px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 6px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .section-header-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-count {
      font-size: 11px;
      color: #6b7280;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .badge-abaixo {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .badge-media {
      background: #dbeafe;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .badge-acima {
      background: #fef9c3;
      color: #854d0e;
      border: 1px solid #facc15;
    }

    .badge-muito {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* Lista lateral (abaixo + média) */
    .lista-postos {
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .lista-postos::-webkit-scrollbar {
      width: 6px;
    }

    .lista-postos::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 999px;
    }

    .posto-item {
      padding: 6px 2px;
      border-bottom: 1px dashed #e5e7eb;
      font-size: 12px;
    }

    .posto-item:last-child {
      border-bottom: none;
    }

    .posto-nome {
      font-weight: 600;
      color: #111827;
    }

    .posto-det {
      font-size: 11px;
      color: #6b7280;
    }

    /* Tabela (acima / muito acima) */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 6px;
    }

    table thead {
      background: #001059;
      color: #f9fafb;
    }

    th,
    td {
      padding: 6px 4px;
      border: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      font-weight: 600;
      font-size: 11px;
    }

    /* Área do mapa à direita */
    .map-panel {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-card {
      flex: 1;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
    }

    .map-header span {
      font-size: 11px;
      color: #6b7280;
    }

    #map {
      flex: 1;
      border-radius: 12px;
      overflow: hidden;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
    }

    /* Loader simples */
    .loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 5px solid #e5e7eb;
      border-top: 5px solid #48ef6c;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      animation: spin 1s linear infinite;
      display: none;
      z-index: 999;
    }

    @keyframes spin {
      0% {
        transform: translate(-50%, -50%) rotate(0deg);
      }
      100% {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }

    /* Responsivo */
    @media (max-width: 960px) {
      body {
        flex-direction: column;
        height: auto;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
      .main-panel {
        width: 100%;
        border-right: none;
        border-top: 3px solid #001059;
      }
      .map-panel {
        padding: 10px;
        height: 380px;
      }
    }
  </style>
</head>

<body>
  <div class="loader" id="loader"></div>

  <!-- Barra superior de contadores -->
  <div class="top-summary">
    <div class="top-pill">
      <span class="num" id="pillTotal">0</span>
      <span>postos filtrados</span>
    </div>
    <div class="top-pill">
      <span class="num" id="pillBloqueados">0</span>
      <span>Bloqueados</span>
    </div>
    <div class="top-pill">
      <span class="num" id="pillAbaixo">0</span>
      <span>Abaixo</span>
    </div>
    <div class="top-pill">
      <span class="num" id="pillMedia">0</span>
      <span>Na média</span>
    </div>
    <div class="top-pill">
      <span class="num" id="pillAcima">0</span>
      <span>Acima</span>
    </div>
    <div class="top-pill">
      <span class="num" id="pillMuito">0</span>
      <span>Muito acima</span>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <!-- Logo branca -->
      <img src="Imagem1.png" alt="Alloha Fibra" />
    </div>
    <div>
      <div class="sidebar-title-main">Painel de Postos</div>
      <div class="sidebar-title-sub">Desvio de Preço &amp; Classificação</div>
      <div class="sidebar-info">
        Foco em <strong>postos abaixo da média</strong> no mapa e visão
        geral dos <strong>demais grupos</strong> em listas e tabela.
      </div>
      <span class="tag">Alloha Frotas · Uso interno</span>
    </div>
  </aside>

  <!-- Painel central (filtros + listas + tabela) -->
  <main class="main-panel">
    <section>
      <h2>Filtros</h2>
      <small>Use os filtros para localizar rapidamente os postos por UF, cidade, combustível, nome ou endereço.</small>

      <div class="filtros">
        <div>
          <label for="filtroUF">UF</label>
          <select id="filtroUF">
            <option value="">Todas</option>
          </select>
        </div>

        <div>
          <label for="filtroCidade">Cidade</label>
          <select id="filtroCidade">
            <option value="">Todas</option>
          </select>
        </div>

        <div>
          <label for="filtroCombustivel">Tipo de Combustível</label>
          <select id="filtroCombustivel">
            <option value="">Todos</option>
          </select>
        </div>

        <div>
          <label for="filtroNome">Nome do posto</label>
          <input type="text" id="filtroNome" placeholder="Digite parte do nome" />
        </div>

        <div>
          <label for="filtroEndereco">Endereço</label>
          <input
            type="text"
            id="filtroEndereco"
            placeholder="Digite parte do logradouro"
          />
        </div>
      </div>
    </section>

    <!-- Lista: abaixo + na média -->
    <section class="section-card">
      <div class="section-header">
        <div class="section-header-title">
          <span class="badge badge-abaixo">Abaixo</span>
          <span class="badge badge-media">Na média</span>
          Postos em situação aceitável ou melhor
        </div>
        <div class="section-count" id="countLista">(0)</div>
      </div>
      <div class="lista-postos" id="listaPostos"></div>
    </section>

    <!-- Tabela: acima + muito acima -->
    <section class="section-card">
      <div class="section-header">
        <div class="section-header-title">
          <span class="badge badge-acima">Acima</span>
          <span class="badge badge-muito">Muito acima</span>
          Postos com desvio crítico
        </div>
        <div class="section-count" id="countTabela">(0)</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Posto</th>
            <th>Cidade/UF</th>
            <th>Comb.</th>
            <th>Desvio (%)</th>
            <th>Preço (R$)</th>
            <th>Grupo</th>
          </tr>
        </thead>
        <tbody id="tabelaAcima"></tbody>
      </table>
    </section>
  </main>

  <!-- Painel de mapa -->
  <section class="map-panel">
    <div class="map-card">
      <div class="map-header">
        <div>Mapa – Postos abaixo da média</div>
        <span>O mapa exibe somente os postos classificados como “Abaixo da média”.</span>
      </div>
      <div id="map"></div>
      <div class="hint">
        Dica: use os filtros para focar em uma região específica. Os marcadores
        exibem nome, endereço, combustível, desvio e preço.
      </div>
    </div>
  </section>

  <script>
    // ============ CONFIG ============

    // URL RAW do XLSX no GitHub
    // Ajuste se seu usuário, repositório, branch ou nome de arquivo forem diferentes.
      const XLSX_FILE_URL =
  "https://github.com/wenderaguiari/Postos-mapa/blob/main/mapa-postos.xlsx?raw=1";


    const loader = document.getElementById("loader");
    function showLoader(show) {
      loader.style.display = show ? "block" : "none";
    }

    let postos = [];
    let map, markersLayer;
    const geocodeCache =
      JSON.parse(localStorage.getItem("geocodeCachePostosAbaixo")) || {};

    function saveCache() {
      localStorage.setItem(
        "geocodeCachePostosAbaixo",
        JSON.stringify(geocodeCache)
      );
    }

    function getCol(row, name) {
      const key = Object.keys(row).find(
        (k) => k.trim().toLowerCase() === name.trim().toLowerCase()
      );
      return key ? row[key] : "";
    }

    function parsePreco(valor) {
      if (valor === null || valor === undefined) return null;
      let s = String(valor).replace(/[R$\s]/g, "");
      if (s === "") return null;
      if (s.indexOf(",") >= 0 && s.indexOf(".") === -1) {
        s = s.replace(".", "").replace(",", ".");
      }
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function parseDesvio(valor) {
      if (valor === null || valor === undefined) return null;
      let s = String(valor).replace("%", "").trim();
      if (s.indexOf(".") >= 0 && s.indexOf(",") >= 0) {
        s = s.replace(".", "").replace(",", ".");
      } else if (s.indexOf(",") >= 0) {
        s = s.replace(",", ".");
      }
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function fmt2(n) {
      return n !== null && !isNaN(n) ? n.toFixed(2) : "";
    }

    function classificarStatus(blacklist) {
      if (!blacklist) return "desconhecido";
      const s = String(blacklist);
      if (s.includes("Bloqueado") || s.includes("Bloqueio")) return "bloqueado";
      if (s.includes("Abaixo da média")) return "abaixo";
      if (s.includes("Dentro da média")) return "media";
      if (s.includes("Muito acima")) return "muito_acima";
      if (s.includes("Acima da média")) return "acima";
      return "desconhecido";
    }

    // ============ LEITURA XLSX ============

    async function carregarXLSX() {
      showLoader(true);
      try {
        const resp = await fetch(XLSX_FILE_URL);
        const arrayBuffer = await resp.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });

        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        const data = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        postos = data
          .map((row) => {
            const nome =
              getCol(row, "Nome EC") || getCol(row, "Nome") || getCol(row, "Posto");
            const uf =
              getCol(row, "UF EC") || getCol(row, "UF") || getCol(row, "Estado");
            const cidade =
              getCol(row, "Cidade EC") || getCol(row, "Cidade") || "";
            const logradouro =
              getCol(row, "Logradouro EC") ||
              getCol(row, "Logradouro") ||
              getCol(row, "Endereco") ||
              getCol(row, "Endereço");
            const desvioBruto =
              getCol(row, "Desvio de Preço (%)") ||
              getCol(row, "Desvio de Preco (%)") ||
              getCol(row, "Desvio (%)") ||
              getCol(row, "Desvio");
            const blacklist = getCol(row, "Blacklist") || getCol(row, "Classificacao");
            const precoBruto =
              getCol(row, "Preço por Litro") ||
              getCol(row, "Preco por Litro") ||
              getCol(row, "Preço") ||
              getCol(row, "Preco");
            const combustivel =
              getCol(row, "Mercadoria") ||
              getCol(row, "Produto") ||
              getCol(row, "Tipo de Combustível") ||
              getCol(row, "Combustível") ||
              getCol(row, "Combustivel");

            if (!nome || !uf || !cidade || !logradouro) return null;

            const status = classificarStatus(blacklist);

            return {
              nome: String(nome).trim(),
              uf: String(uf).trim(),
              cidade: String(cidade).trim(),
              endereco: String(logradouro).trim(),
              combustivel: String(combustivel || "").trim(),
              blacklist: blacklist,
              status: status,
              desvioNum: parseDesvio(desvioBruto),
              precoNum: parsePreco(precoBruto),
            };
          })
          .filter((x) => x !== null);

        inicializarMapa();
        inicializarFiltros();
        await atualizarInterface();
      } catch (e) {
        console.error("Erro ao carregar XLSX:", e);
        alert(
          "Erro ao carregar o arquivo XLSX do GitHub. Confira a URL em XLSX_FILE_URL e se o repositório/arquivo são públicos."
        );
      } finally {
        showLoader(false);
      }
    }

    // ============ FILTROS ============

    function inicializarFiltros() {
      const ufSelect = document.getElementById("filtroUF");
      const cidadeSelect = document.getElementById("filtroCidade");
      const combSelect = document.getElementById("filtroCombustivel");
      const nomeInput = document.getElementById("filtroNome");
      const endInput = document.getElementById("filtroEndereco");

      // UFs
      const ufs = Array.from(new Set(postos.map((p) => p.uf))).sort();
      ufs.forEach((uf) => {
        const opt = document.createElement("option");
        opt.value = uf;
        opt.textContent = uf;
        ufSelect.appendChild(opt);
      });

      // Combustíveis
      const combustiveis = Array.from(
        new Set(
          postos
            .map((p) => p.combustivel)
            .filter((c) => c && c.trim() !== "")
        )
      ).sort();
      combustiveis.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        combSelect.appendChild(opt);
      });

      ufSelect.addEventListener("change", () => {
        preencherCidades();
        atualizarInterface();
      });
      cidadeSelect.addEventListener("change", atualizarInterface);
      combSelect.addEventListener("change", atualizarInterface);
      nomeInput.addEventListener("input", atualizarInterface);
      endInput.addEventListener("input", atualizarInterface);

      preencherCidades();
    }

    function preencherCidades() {
      const uf = document.getElementById("filtroUF").value;
      const cidadeSelect = document.getElementById("filtroCidade");
      cidadeSelect.innerHTML = '<option value="">Todas</option>';

      const cidades = Array.from(
        new Set(
          postos
            .filter((p) => (!uf || p.uf === uf))
            .map((p) => p.cidade)
        )
      ).sort();

      cidades.forEach((cidade) => {
        const opt = document.createElement("option");
        opt.value = cidade;
        opt.textContent = cidade;
        cidadeSelect.appendChild(opt);
      });
    }

    function filtrarPostos() {
      const uf = document.getElementById("filtroUF").value;
      const cidade = document.getElementById("filtroCidade").value;
      const comb = document.getElementById("filtroCombustivel").value;
      const nome = document.getElementById("filtroNome").value.toLowerCase();
      const endereco = document
        .getElementById("filtroEndereco")
        .value.toLowerCase();

      return postos.filter((p) => {
        return (
          (!uf || p.uf === uf) &&
          (!cidade || p.cidade === cidade) &&
          (!comb || p.combustivel === comb) &&
          (!nome || p.nome.toLowerCase().includes(nome)) &&
          (!endereco || p.endereco.toLowerCase().includes(endereco))
        );
      });
    }

    // ============ MAPA ============

    function inicializarMapa() {
      map = L.map("map").setView([-15.78, -47.93], 4);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    async function geocodeEndereco(posto) {
      const chave = `${posto.endereco}, ${posto.cidade} - ${posto.uf}`;
      if (geocodeCache[chave]) {
        return geocodeCache[chave];
      }

      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(
        chave
      )}`;

      try {
        const resp = await fetch(url, {
          headers: {
            "Accept-Language": "pt-BR",
          },
        });
        const data = await resp.json();
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          const coord = { lat, lon };
          geocodeCache[chave] = coord;
          saveCache();
          return coord;
        }
      } catch (e) {
        console.error("Erro no geocode:", e);
      }
      return null;
    }

    async function atualizarMapa(postosFiltrados) {
      markersLayer.clearLayers();

      const abaixo = postosFiltrados.filter((p) => p.status === "abaixo");

      if (abaixo.length === 0) return;

      const bounds = [];
      // Limita quantidade para não ficar pesado
      const limitados = abaixo.slice(0, 80);

      for (const posto of limitados) {
        const coord = await geocodeEndereco(posto);
        if (!coord) continue;

        const parts = [];
        parts.push(`<strong>${posto.nome}</strong>`);
        parts.push(`${posto.endereco}`);
        parts.push(`${posto.cidade} - ${posto.uf}`);
        if (posto.combustivel) {
          parts.push(`Combustível: ${posto.combustivel}`);
        }
        if (posto.desvioNum !== null) {
          parts.push(`Desvio: ${fmt2(posto.desvioNum)}%`);
        }
        if (posto.precoNum !== null) {
          parts.push(`Preço: R$ ${fmt2(posto.precoNum)}`);
        }

        const marker = L.circleMarker([coord.lat, coord.lon], {
          radius: 7,
          fillColor: "#22c55e",
          color: "#14532d",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.9,
        }).addTo(markersLayer);

        marker.bindPopup(parts.join("<br />"));
        bounds.push([coord.lat, coord.lon]);
      }

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    // ============ LISTA (abaixo + média) ============

    function atualizarLista(postosFiltrados) {
      const container = document.getElementById("listaPostos");
      const countEl = document.getElementById("countLista");
      container.innerHTML = "";

      const lista = postosFiltrados.filter(
        (p) => p.status === "abaixo" || p.status === "media"
      );

      countEl.textContent = `(${lista.length})`;

      lista.forEach((p) => {
        const div = document.createElement("div");
        div.className = "posto-item";

        const labelStatus =
          p.status === "abaixo"
            ? '<span class="badge badge-abaixo">Abaixo da média</span>'
            : '<span class="badge badge-media">Na média</span>';

        div.innerHTML =
          `<div class="posto-nome">${p.nome}</div>` +
          `<div class="posto-det">${p.endereco}</div>` +
          `<div class="posto-det">${p.cidade} / ${p.uf}</div>` +
          (p.combustivel
            ? `<div class="posto-det">Combustível: ${p.combustivel}</div>`
            : "") +
          (p.desvioNum !== null
            ? `<div class="posto-det">Desvio: ${fmt2(
                p.desvioNum
              )}%</div>`
            : "") +
          (p.precoNum !== null
            ? `<div class="posto-det">Preço: R$ ${fmt2(
                p.precoNum
              )}</div>`
            : "") +
          `<div class="posto-det">${labelStatus}</div>`;

        container.appendChild(div);
      });
    }

    // ============ TABELA (acima + muito acima) ============

    function atualizarTabela(postosFiltrados) {
      const tbody = document.getElementById("tabelaAcima");
      const countEl = document.getElementById("countTabela");
      tbody.innerHTML = "";

      const lista = postosFiltrados.filter(
        (p) => p.status === "acima" || p.status === "muito_acima"
      );

      // Ordenar por desvio desc, se houver
      lista.sort((a, b) => (b.desvioNum || 0) - (a.desvioNum || 0));

      countEl.textContent = `(${lista.length})`;

      lista.forEach((p) => {
        const tr = document.createElement("tr");

        const grupoBadge =
          p.status === "muito_acima"
            ? '<span class="badge badge-muito">Muito acima</span>'
            : '<span class="badge badge-acima">Acima da média</span>';

        tr.innerHTML =
          `<td>${p.nome}</td>` +
          `<td>${p.cidade} / ${p.uf}</td>` +
          `<td>${p.combustivel || ""}</td>` +
          `<td>${p.desvioNum !== null ? fmt2(p.desvioNum) + "%" : ""}</td>` +
          `<td>${p.precoNum !== null ? "R$ " + fmt2(p.precoNum) : ""}</td>` +
          `<td>${grupoBadge}</td>`;

        tbody.appendChild(tr);
      });
    }

    // ============ CONTADORES SUPERIORES ============

    function atualizarContadores(postosFiltrados) {
      const total = postosFiltrados.length;
      let abaixo = 0,
        media = 0,
        acima = 0,
        muito = 0,
        bloqueados = 0;

      postosFiltrados.forEach((p) => {
        if (p.status === "bloqueado") bloqueados++;
        else if (p.status === "abaixo") abaixo++;
        else if (p.status === "media") media++;
        else if (p.status === "acima") acima++;
        else if (p.status === "muito_acima") muito++;
      });

      document.getElementById("pillTotal").textContent = total;
      document.getElementById("pillBloqueados").textContent = bloqueados;
      document.getElementById("pillAbaixo").textContent = abaixo;
      document.getElementById("pillMedia").textContent = media;
      document.getElementById("pillAcima").textContent = acima;
      document.getElementById("pillMuito").textContent = muito;
    }

    // ============ ATUALIZAÇÃO GERAL ============

    async function atualizarInterface() {
      showLoader(true);
      const filtrados = filtrarPostos();
      atualizarContadores(filtrados);
      atualizarLista(filtrados);
      atualizarTabela(filtrados);
      await atualizarMapa(filtrados);
      showLoader(false);
    }

    // Início
    carregarXLSX();
  </script>
</body>
</html>
