<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Postos - Alloha Fibra</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- SheetJS para XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui;
      font-size: 14px;
      background: #f3f6fb;
      color: #001059;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 240px;
      background: #001059;
      color: #f9fafb;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.25);
    }

    .sidebar-logo img {
      max-width: 140px;
      display: block;
      margin: 0 auto 6px;
    }

    .sidebar-title-main {
      font-size: 16px;
      font-weight: 600;
    }

    .sidebar-title-sub {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #48ef6c;
      color: #48ef6c;
      background: rgba(72, 239, 108, 0.15);
    }

    #statsBox {
      margin-top: 8px;
      font-size: 12px;
    }

    #statsBox span {
      font-weight: 600;
    }

    .main-panel {
      width: 420px;
      background: #fff;
      padding: 10px 14px;
      border-right: 2px solid #001059;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
    }

    h2 {
      margin: 0 0 4px;
      font-size: 16px;
    }

    small {
      font-size: 12px;
      color: #6b7280;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin: 6px 0 2px;
      display: block;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 6px 9px;
      border-radius: 999px;
      border: 2px solid #001059;
      background: #f9fafb;
      font-size: 13px;
    }

    select:focus,
    input:focus {
      border-color: #48ef6c;
      background: #fff;
      box-shadow: 0 0 0 2px rgba(72, 239, 108, 0.25);
    }

    .section-card {
      margin-top: 8px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 8px;
      font-size: 13px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .section-count {
      font-size: 12px;
      color: #6b7280;
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
    }

    .badge-abaixo {
      background: #dcfce7;
      color: #166534;
    }

    .badge-media {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .badge-acima {
      background: #fef9c3;
      color: #854d0e;
    }

    .badge-muito {
      background: #fee2e2;
      color: #b91c1c;
    }

    .posto-item {
      padding: 5px 2px;
      border-bottom: 1px dashed #e5e7eb;
      cursor: pointer;
    }

    .posto-item:hover {
      background: #e5ebff;
    }

    .map-panel {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #map {
      flex: 1;
      border-radius: 12px;
      border: 2px solid #001059;
      overflow: hidden;
    }

    .loader {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #48ef6c;
      transform: translate(-50%, -50%);
      animation: spin 1s linear infinite;
      display: none;
      z-index: 999;
    }

    @keyframes spin {
      0% {
        transform: translate(-50%, -50%) rotate(0deg);
      }

      100% {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="loader" id="loader"></div>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="Imagem1.png" />
    </div>

    <div class="sidebar-title-main">Painel de Postos</div>
    <div class="sidebar-title-sub">Desvio de Preço & Classificação</div>

    <span class="tag">Alloha Frotas · Uso interno</span>

    <div id="statsBox">
      <div>Abaixo: <span id="statsAbaixo">0</span></div>
      <div>Média: <span id="statsMedia">0</span></div>
      <div>Acima: <span id="statsAcima">0</span></div>
      <div>Muito acima: <span id="statsMuito">0</span></div>
    </div>
  </aside>

  <!-- PAINEL CENTRAL -->
  <main class="main-panel">
    <section>
      <h2>Filtros</h2>
      <small>Use os filtros para localizar rapidamente os postos.</small>

      <label>UF</label>
      <select id="filtroUF">
        <option value="">Todas</option>
      </select>

      <label>Cidade</label>
      <select id="filtroCidade">
        <option value="">Todas</option>
      </select>

      <label>Mercadoria</label>
      <select id="filtroMercadoria">
        <option value="">Todas</option>
      </select>

      <label>Nome do posto</label>
      <input
        type="text"
        id="filtroNome"
        placeholder="Digite parte do nome"
      />

      <label>Endereço</label>
      <input
        type="text"
        id="filtroEndereco"
        placeholder="Digite parte do endereço"
      />
    </section>

    <!-- LISTA TOP 10 -->
    <section class="section-card" id="cardLista">
      <div class="section-title">
        <span class="badge badge-abaixo">Abaixo</span>
        <span class="badge badge-media">Na média</span>
        Top 10 mais baratos
        <span class="section-count" id="countLista">(0)</span>
      </div>
      <div id="listaPostos"></div>
    </section>

    <!-- TABELA ACIMA / MUITO ACIMA -->
    <section class="section-card" id="cardTabela">
      <div class="section-title">
        <span class="badge badge-acima">Acima</span>
        <span class="badge badge-muito">Muito acima</span>
        Postos com desvio crítico
        <span class="section-count" id="countTabela">(0)</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>Posto</th>
            <th>Cidade/UF</th>
            <th>Desvio (%)</th>
            <th>Preço</th>
            <th>Grupo</th>
          </tr>
        </thead>
        <tbody id="tabelaAcima"></tbody>
      </table>
    </section>
  </main>

  <!-- MAPA -->
  <section class="map-panel">
    <h3>Mapa – Postos abaixo da média</h3>
    <small>Somente os 10 mais baratos aparecem no mapa.</small>
    <div id="map"></div>
  </section>

  <script>
    const XLSX_FILE = "mapa-postos.xlsx";

    let postos = [];
    let map, markersLayer;

    function showLoader(v) {
      document.getElementById("loader").style.display = v ? "block" : "none";
    }

    function parsePreco(v) {
      if (!v) return null;
      v = String(v).replace(",", ".");
      return parseFloat(v);
    }

    function parseDesvio(v) {
      if (!v) return null;
      v = String(v).replace(",", ".");
      return parseFloat(v);
    }

    function fmt2(n) {
      return n ? n.toFixed(2) : "";
    }

    function classificarStatus(txt) {
      if (!txt) return "desconhecido";
      const s = String(txt);
      if (s.includes("Abaixo")) return "abaixo";
      if (s.includes("Dentro")) return "media";
      if (s.includes("Muito")) return "muito_acima";
      if (s.includes("Acima")) return "acima";
      return "desconhecido";
    }

    // --------- CARREGAR XLSX ---------
    async function carregarXLSX() {
      showLoader(true);

      const resp = await fetch(XLSX_FILE);
      const blob = await resp.blob();
      const data = await blob.arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      postos = json.map((row) => ({
        nome: row["Nome EC"],
        uf: row["UF EC"],
        cidade: row["Cidade EC"],
        endereco: row["Logradouro EC"],
        mercadoria: row["Mercadoria"],
        precoNum: parsePreco(row["Preço por Litro"]),
        desvioNum: parseDesvio(row["Desvio de Preço (%)"]),
        blacklist: row["Blacklist"],
        status: classificarStatus(row["Blacklist"]),

        _marker: null,
      }));

      inicializarMapa();
      inicializarFiltros();
      atualizarInterface();

      showLoader(false);
    }

    // --------- MAPA ---------
    function inicializarMapa() {
      map = L.map("map").setView([-14.5, -51.5], 4);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map
      );

      markersLayer = L.layerGroup().addTo(map);
    }

    // Cache de coordenadas
    const geocodeCache = {};
    // --------- MAPA + ZOOM CORRIGIDO ---------
    async function atualizarMapa(lista) {
      markersLayer.clearLayers();

      const uf = document.getElementById("filtroUF").value;
      const cidade = document.getElementById("filtroCidade").value;

      // --- ZOOM POR UF OU CIDADE (CORRIGIDO) ---
      try {
        if (cidade && uf) {
          const qCidade = `${cidade}, ${uf}, Brasil`;

          if (!geocodeCache[qCidade]) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(qCidade)}`;
            const r = await fetch(url);
            const d = await r.json();
            if (d.length > 0) {
              geocodeCache[qCidade] = [parseFloat(d[0].lat), parseFloat(d[0].lon)];
            }
          }

          if (geocodeCache[qCidade]) {
            map.setView(geocodeCache[qCidade], 12);
          }
        }

        else if (uf) {
          const qUF = `${uf}, Brasil`;

          if (!geocodeCache[qUF]) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(qUF)}`;
            const r = await fetch(url);
            const d = await r.json();
            if (d.length > 0) {
              geocodeCache[qUF] = [parseFloat(d[0].lat), parseFloat(d[0].lon)];
            }
          }

          if (geocodeCache[qUF]) {
            map.setView(geocodeCache[qUF], 6);
          }
        }
      } catch (e) {
        console.warn("Erro no zoom:", e);
      }

      // --- MARCADORES (10 mais baratos) ---
      const abaixo = lista
        .filter((p) => p.status === "abaixo" || p.status === "media")
        .sort((a, b) => a.precoNum - b.precoNum)
        .slice(0, 10);

      for (const p of abaixo) {
        const q = `${p.endereco}, ${p.cidade} - ${p.uf}`;

        if (!geocodeCache[q]) {
          const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
          try {
            const r = await fetch(url);
            const d = await r.json();
            if (!d.length) continue;

            geocodeCache[q] = [parseFloat(d[0].lat), parseFloat(d[0].lon)];
          } catch (e) {
            console.error("Erro ao geocodificar:", q);
            continue;
          }
        }

        const [lat, lon] = geocodeCache[q];

        const m = L.circleMarker([lat, lon], {
          radius: 6,
          fillColor: "#22c55e",
          color: "#14532d",
          weight: 2,
          fillOpacity: 0.9,
        }).addTo(markersLayer);

        m.bindPopup(
          `<strong>${p.nome}</strong><br>${p.endereco}<br>${p.cidade} - ${p.uf}<br>R$ ${fmt2(p.precoNum)}`
        );

        p._marker = m;
      }
    }

    // --------- FILTROS ---------
    function inicializarFiltros() {
      const ufSel = document.getElementById("filtroUF");
      const mercSel = document.getElementById("filtroMercadoria");

      [...new Set(postos.map((p) => p.uf))]
        .sort()
        .forEach((u) => {
          ufSel.innerHTML += `<option value="${u}">${u}</option>`;
        });

      [...new Set(postos.map((p) => p.mercadoria))]
        .sort()
        .forEach((m) => {
          if (m) mercSel.innerHTML += `<option value="${m}">${m}</option>`;
        });

      ufSel.onchange = () => preencherCidades();
      document.getElementById("filtroCidade").onchange = atualizarInterface;
      mercSel.onchange = atualizarInterface;

      document.getElementById("filtroNome").oninput = atualizarInterface;
      document.getElementById("filtroEndereco").oninput = atualizarInterface;

      preencherCidades();
    }

    function preencherCidades() {
      const uf = document.getElementById("filtroUF").value;
      const cidSel = document.getElementById("filtroCidade");

      cidSel.innerHTML = `<option value="">Todas</option>`;

      [...new Set(postos.filter((p) => !uf || p.uf === uf).map((p) => p.cidade))]
        .sort()
        .forEach((c) => {
          cidSel.innerHTML += `<option value="${c}">${c}</option>`;
        });

      atualizarInterface();
    }

    function filtrar() {
      const uf = document.getElementById("filtroUF").value;
      const cid = document.getElementById("filtroCidade").value;
      const m = document.getElementById("filtroMercadoria").value;
      const nome = document.getElementById("filtroNome").value.toLowerCase();
      const end = document.getElementById("filtroEndereco").value.toLowerCase();

      return postos.filter(
        (p) =>
          (!uf || p.uf === uf) &&
          (!cid || p.cidade === cid) &&
          (!m || p.mercadoria === m) &&
          (!nome || p.nome.toLowerCase().includes(nome)) &&
          (!end || p.endereco.toLowerCase().includes(end))
      );
    }

    function atualizarInterface() {
      const list = filtrar();
      atualizarStats(list);
      atualizarLista(list);
      atualizarTabela(list);
      atualizarMapa(list);
    }

    function atualizarStats(list) {
      document.getElementById("statsAbaixo").textContent = list.filter((p) => p.status === "abaixo").length;
      document.getElementById("statsMedia").textContent = list.filter((p) => p.status === "media").length;
      document.getElementById("statsAcima").textContent = list.filter((p) => p.status === "acima").length;
      document.getElementById("statsMuito").textContent = list.filter((p) => p.status === "muito_acima").length;
    }

    function atualizarLista(list) {
      const div = document.getElementById("listaPostos");
      div.innerHTML = "";

      const top = list
        .filter((p) => p.status === "abaixo" || p.status === "media")
        .sort((a, b) => a.precoNum - b.precoNum)
        .slice(0, 10);

      document.getElementById("countLista").textContent = `(${top.length})`;

      top.forEach((p) => {
        div.innerHTML += `
          <div class="posto-item">
            <div><strong>${p.nome}</strong></div>
            <div>${p.cidade} - ${p.uf}</div>
            <div>R$ ${fmt2(p.precoNum)} • ${fmt2(p.desvioNum)}%</div>
          </div>
        `;
      });
    }

    function atualizarTabela(list) {
      const tbody = document.getElementById("tabelaAcima");
      tbody.innerHTML = "";

      const crit = list
        .filter((p) => p.status === "acima" || p.status === "muito_acima")
        .sort((a, b) => b.desvioNum - a.desvioNum);

      document.getElementById("countTabela").textContent = `(${crit.length})`;

      crit.forEach((p) => {
        tbody.innerHTML += `
          <tr>
            <td>${p.nome}</td>
            <td>${p.cidade} / ${p.uf}</td>
            <td>${fmt2(p.desvioNum)}%</td>
            <td>R$ ${fmt2(p.precoNum)}</td>
            <td>${p.status}</td>
          </tr>
        `;
      });
    }

    // INICIAR
    carregarXLSX();
  </script>
</body>
</html>
